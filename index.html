<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAR ROOM : TOTAL STRATEGY</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            /* THEME TACTIQUE */
            --bg-ui: #f0f2f5;
            --bg-panel: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #666;
            --border-ui: #ccc;
            --btn-bg: #2c3e50;
            --btn-txt: #fff;
            
            /* CARTE CLAIRE */
            --map-sea: #d4dadc;
            --land-fill: #ffffff;
            --land-stroke: #888;
            --land-hover: #555;
            --land-active: #222;
        }

        [data-theme="cyber"] {
            /* THEME CYBER */
            --bg-ui: #000000;
            --bg-panel: #0a0a0a;
            --text-main: #00ffcc;
            --text-muted: #006655;
            --border-ui: #004433;
            --btn-bg: #00ffcc;
            --btn-txt: #000;

            /* CARTE SOMBRE */
            --map-sea: #020202;
            --land-fill: #111;
            --land-stroke: #003322;
            --land-hover: #002211;
            --land-active: #00ffcc;
        }

        body { margin: 0; font-family: 'Share Tech Mono', monospace; background: var(--bg-ui); color: var(--text-main); overflow: hidden; transition: 0.3s; }

        /* --- CARTE --- */
        #map { height: 100vh; width: 100vw; z-index: 1; background: var(--map-sea); transition: background 0.5s; }
        
        /* Styles des pays */
        path.country-poly {
            fill: var(--land-fill); stroke: var(--land-stroke); stroke-width: 1px;
            transition: all 0.3s; vector-effect: non-scaling-stroke;
        }
        path.country-poly:hover { fill: var(--land-hover) !important; stroke-width: 2px; cursor: pointer; }
        path.country-poly.active-country { fill: var(--land-hover) !important; stroke: var(--land-active) !important; stroke-width: 2px; }

        /* --- HUD --- */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: var(--bg-ui); border-bottom: 1px solid var(--border-ui);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            z-index: 1000; font-size: 13px; padding-top: 5px;
        }
        .res-box i { margin-right: 3px; color: var(--text-muted); }
        [data-theme="cyber"] .res-box i { color: var(--text-main); }

        /* --- MENU --- */
        #side-menu {
            position: absolute; top: 45px; left: 0; bottom: 0; width: 340px;
            background: var(--bg-panel); border-right: 1px solid var(--border-ui);
            display: flex; flex-direction: column; z-index: 1000; transition: 0.3s;
        }
        .panel-head { padding: 10px; text-align: center; border-bottom: 1px solid var(--border-ui); font-size: 16px; font-weight: bold; background: var(--bg-ui); }
        .scroll-area { flex: 1; overflow-y: auto; }

        /* LISTE */
        .list-item { padding: 6px 15px; border-bottom: 1px solid var(--border-ui); cursor: pointer; font-size: 12px; color: var(--text-muted); }
        .list-item:hover { background: var(--bg-ui); color: var(--text-main); border-left: 3px solid var(--text-main); }
        .list-item.active { background: var(--btn-bg); color: var(--btn-txt); font-weight: bold; }

        /* BATIMENTS */
        .build-card { padding: 10px; border-bottom: 1px solid var(--border-ui); background: var(--bg-panel); }
        .build-info { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .build-desc { font-size: 10px; color: var(--text-muted); margin-bottom: 5px; font-style: italic; }
        .build-cost { font-size: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; color: var(--text-muted); margin-bottom: 8px; }
        
        button.btn-action {
            width: 100%; padding: 8px; background: var(--btn-bg); color: var(--btn-txt); border: none;
            cursor: pointer; font-family: inherit; font-weight: bold; text-transform: uppercase; font-size: 12px;
        }
        button.btn-action:hover { opacity: 0.8; }
        
        /* --- ELEMENTS JEU --- */
        .token {
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; width: 100%; height: 100%;
            background: var(--bg-panel); border: 2px solid var(--text-main); color: var(--text-main);
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .crosshair { cursor: crosshair !important; }
        #day-night-overlay { pointer-events: none; position: absolute; top:0; left:0; width:100%; height:100%; z-index: 500; mix-blend-mode: multiply; transition: opacity 2s; }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; color: #fff; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-satellite fa-spin fa-2x"></i>
        <div style="margin-top:10px;">INITIALISATION DU SYSTÈME GÉOSPATIAL...</div>
    </div>

    <div id="top-bar">
        <div class="res-box"><i class="fas fa-money-bill"></i><span id="r-money">0</span></div>
        <div class="res-box"><i class="fas fa-users"></i><span id="r-pop">0</span>M</div>
        <div class="res-box"><i class="fas fa-person-rifle"></i><span id="r-soldier">0</span></div>
        <div class="res-box"><i class="fas fa-cubes"></i><span id="r-stone">0</span></div>
        <div class="res-box"><i class="fas fa-tree"></i><span id="r-wood">0</span></div>
        <div class="res-box"><i class="fas fa-industry"></i><span id="r-iron">0</span></div>
        <div class="res-box"><i class="fas fa-oil-well"></i><span id="r-oil">0</span></div>
        <div class="res-box"><i class="fas fa-radiation"></i><span id="r-nuke">0</span></div>
        <div style="margin-left:auto; margin-right:10px; border:1px solid var(--text-main); padding:2px 5px;">
            <span id="clock">12:00</span>
        </div>
    </div>

    <div id="side-menu">
        <div id="view-select" style="display:flex; flex-direction:column; height:100%;">
            <div class="panel-head">CIBLE GÉOGRAPHIQUE</div>
            <div id="country-list" class="scroll-area"></div>
            <div style="padding:15px; border-top:1px solid var(--border-ui);">
                <h3 id="sel-name" style="margin:0 0 5px 0;">---</h3>
                <div id="sel-desc" style="font-size:11px; margin-bottom:10px; color:var(--text-muted);">En attente de données...</div>
                <button id="btn-start" class="btn-action" disabled onclick="startGame()">LANCER LA SESSION</button>
            </div>
        </div>

        <div id="view-game" style="display:none; flex-direction:column; height:100%;">
            <div class="panel-head">INFRASTRUCTURES</div>
            <div id="build-list" class="scroll-area"></div>
            <div style="padding:10px;">
                <button class="btn-action" onclick="toggleTheme()">MODE VISUEL (Toggle)</button>
            </div>
        </div>
    </div>

    <div id="day-night-overlay"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DONNÉES COMPLÈTES DES BÂTIMENTS ---
        const BUILDINGS = {
            house: { name: "QUARTIER RESID.", desc: "+Population", cost: { money: 100, wood: 20 }, prod: { pop: 2 }, icon: "fa-house" },
            quarry: { name: "CARRIÈRE", desc: "+Pierre", cost: { money: 300 }, prod: { stone: 5 }, icon: "fa-mound" },
            sawmill: { name: "SCIERIE", desc: "+Bois", cost: { money: 300 }, prod: { wood: 5 }, icon: "fa-tree" },
            mine: { name: "MINE DE FER", desc: "+Fer", cost: { money: 800, wood: 50 }, prod: { iron: 3 }, icon: "fa-hammer" },
            oil: { name: "FOREUSE", desc: "+Pétrole", cost: { money: 1500, iron: 50 }, prod: { oil: 2 }, icon: "fa-oil-well" },
            barracks: { name: "CASERNE", desc: "+Soldats", cost: { money: 1000, stone: 100, iron: 20 }, prod: { soldier: 1 }, icon: "fa-person-rifle" },
            bank: { name: "CENTRE FINANCIER", desc: "+Argent", cost: { money: 2000, stone: 200, iron: 100 }, prod: { money: 200 }, icon: "fa-briefcase" },
            nuke: { name: "SILO ICBM", desc: "+Dissuasion", cost: { money: 50000, iron: 2000, oil: 1000 }, prod: { nuke: 0.1 }, icon: "fa-radiation" }
        };

        let state = {
            playing: false, theme: 'tactical', time: 720,
            res: { money: 0, pop: 0, soldier: 0, stone: 0, wood: 0, iron: 0, oil: 0, nuke: 0 },
            buildings: [],
            scaleFactor: 1 // Facteur de taille de la zone
        };
        
        let placementType = null;
        let selectedLayer = null;
        let geoJsonLayer;

        // INIT MAP
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
        const gameLayer = L.layerGroup().addTo(map);

        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
            .then(r => r.json())
            .then(data => {
                geoJsonLayer = L.geoJSON(data, {
                    style: { className: 'country-poly' },
                    onEachFeature: onFeature
                }).addTo(map);
                populateList(data.features);
                document.getElementById('loader').style.display = 'none';
            });

        function onFeature(feature, layer) {
            layer.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                if(placementType) {
                    // Empêcher la construction hors du pays sélectionné
                    if(feature.id !== state.selectedId) {
                        alert("Violation de frontière ! Vous ne pouvez construire que sur votre territoire.");
                        return;
                    }
                    buildAt(e.latlng);
                } else if(!state.playing) {
                    selectCountry(feature, layer);
                }
            });
        }

        // --- SELECTION INTELLIGENTE (TAILLE & ÉCONOMIE) ---
        function selectCountry(feature, layer) {
            if(selectedLayer && selectedLayer._path) selectedLayer._path.classList.remove('active-country');
            selectedLayer = layer;
            if(selectedLayer._path) selectedLayer._path.classList.add('active-country');
            state.selectedId = feature.id;

            // 1. CALCUL DE LA TAILLE GÉOGRAPHIQUE
            const b = layer.getBounds();
            const width = b.getEast() - b.getWest();
            const height = b.getNorth() - b.getSouth();
            const area = width * height; 

            // 2. LOGIQUE ÉCONOMIQUE INVERSÉE (Petit = Riche, Grand = Pauvre)
            let desc = "";
            if (area < 5) {
                state.res.money = 50000; state.res.pop = 2; // Riche paradis fiscal
                desc = "TYPE: MICRO-ETAT (Budget Illimité)";
                state.scaleFactor = 0.5; // Petites zones
            } else if (area > 50) {
                state.res.money = 2000; state.res.pop = 150; // Géant pauvre
                desc = "TYPE: SUPERPUISSANCE (Gestion de Masse)";
                state.scaleFactor = 4.0; // Zones GIGANTESQUES
            } else {
                state.res.money = 8000; state.res.pop = 30; // Standard
                desc = "TYPE: NATION STANDARD";
                state.scaleFactor = 1.5; // Zones normales
            }

            // Ressources de départ de base
            state.res.wood = 200; state.res.stone = 200; state.res.iron = 50; state.res.oil = 0; state.res.soldier = 0;

            document.getElementById('sel-name').innerText = feature.properties.name;
            document.getElementById('sel-desc').innerText = desc + ` | FACTEUR ZONE: x${state.scaleFactor}`;
            document.getElementById('btn-start').disabled = false;

            // Mise en évidence liste
            document.querySelectorAll('.list-item').forEach(l => l.classList.remove('active'));
            const li = document.getElementById('li-' + feature.id);
            if(li) { li.classList.add('active'); li.scrollIntoView({block:'center'}); }
        }

        function populateList(features) {
            const list = document.getElementById('country-list');
            features.sort((a,b) => a.properties.name.localeCompare(b.properties.name));
            features.forEach(f => {
                const d = document.createElement('div'); d.className = 'list-item'; d.id = 'li-'+f.id;
                d.innerText = f.properties.name;
                d.onclick = () => {
                   const l = geoJsonLayer.getLayers().find(lay => lay.feature.id === f.id);
                   if(l) l.fireEvent('click');
                };
                list.appendChild(d);
            });
        }

        // --- BOUCLE DE JEU ---
        function startGame() {
            state.playing = true;
            document.getElementById('view-select').style.display = 'none';
            document.getElementById('view-game').style.display = 'flex';
            map.fitBounds(selectedLayer.getBounds());
            initBuildMenu();
            updateHUD();
            setInterval(gameLoop, 1000);
        }

        function gameLoop() {
            // Production
            state.res.money += Math.floor(state.res.pop / 2); // Taxes
            state.buildings.forEach(b => {
                const p = BUILDINGS[b.type].prod;
                for(let k in p) state.res[k] += p[k] * b.level;
            });
            
            // Temps & Nuit
            state.time += 10; if(state.time >= 1440) state.time = 0;
            const h = Math.floor(state.time/60);
            document.getElementById('clock').innerText = `${h.toString().padStart(2,'0')}:${(state.time%60).toString().padStart(2,'0')}`;
            
            let op = 0;
            if(h >= 20 || h < 6) op = 0.8; 
            else if(h>=18) op = 0.3;
            document.getElementById('day-night-overlay').style.opacity = op;

            updateHUD();
        }

        // --- CONSTRUCTION ---
        function initBuildMenu() {
            const list = document.getElementById('build-list');
            for(let key in BUILDINGS) {
                const b = BUILDINGS[key];
                let costStr = "";
                for(let c in b.cost) costStr += `<span>${c}: ${b.cost[c]}</span>`;

                const d = document.createElement('div');
                d.className = 'build-card';
                d.innerHTML = `
                    <div class="build-info"><span>${b.name}</span> <i class="fas ${b.icon}"></i></div>
                    <div class="build-desc">${b.desc}</div>
                    <div class="build-cost">${costStr}</div>
                    <button class="btn-action" onclick="setPlace('${key}')">CONSTRUIRE</button>
                `;
                list.appendChild(d);
            }
        }

        window.setPlace = function(type) {
            const cost = BUILDINGS[type].cost;
            for(let k in cost) if(state.res[k] < cost[k]) { alert("Ressources manquantes: " + k); return; }
            placementType = type;
            document.getElementById('map').classList.add('crosshair');
        };

        function buildAt(latlng) {
            const type = placementType;
            const cost = BUILDINGS[type].cost;
            for(let k in cost) state.res[k] -= cost[k];

            const level = 1;
            // --- ZONE PROPORTIONNELLE ---
            // Base radius (50km) * Facteur Pays * Niveau
            const baseRadius = 50000; 
            const radius = baseRadius * state.scaleFactor * level;

            const circle = L.circle(latlng, { radius: radius, color: 'var(--text-main)', fillOpacity: 0.1, weight: 1, dashArray:'4,4' }).addTo(gameLayer);
            const icon = L.divIcon({
                className: 'leaflet-div-icon',
                html: `<div class="token"><i class="fas ${BUILDINGS[type].icon}"></i></div>`,
                iconSize: [24,24]
            });
            const marker = L.marker(latlng, {icon:icon}).addTo(gameLayer);

            // Click pour upgrade
            marker.on('click', () => {
                if(confirm("Améliorer ce bâtiment ? Coût doublé.")) {
                    // (Simplification ici pour l'upgrade : on double juste le niveau visuel)
                    circle.setRadius(circle.getRadius() * 1.5);
                    marker.setIcon(L.divIcon({
                        className: 'leaflet-div-icon',
                        html: `<div class="token" style="border-width:3px; font-size:16px;"><i class="fas ${BUILDINGS[type].icon}"></i></div>`,
                        iconSize: [34,34]
                    }));
                }
            });

            state.buildings.push({ type, level, marker, circle });
            placementType = null;
            document.getElementById('map').classList.remove('crosshair');
            updateHUD();
        }

        function updateHUD() {
            const keys = ['money','pop','soldier','stone','wood','iron','oil','nuke'];
            keys.forEach(k => {
                const el = document.getElementById('r-'+k);
                if(el) el.innerText = Math.floor(state.res[k]).toLocaleString();
            });
        }

        window.toggleTheme = function() {
            if(state.theme === 'tactical') {
                document.body.setAttribute('data-theme', 'cyber'); state.theme = 'cyber';
            } else {
                document.body.removeAttribute('data-theme'); state.theme = 'tactical';
            }
        }
    </script>
</body>
</html>
