<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenFront 1918 - Tactical Command Ultimate</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --blue: #00d4ff; --red: #ff3131; --gold: #ffd700;
            --bg: #111; --header-bg: #000; --text: #fff; --map-bg: #000; --border: #333; --panel: #1a1a1a;
        }
        body { 
            margin: 0; background: var(--bg); font-family: 'Arial Black', sans-serif; 
            overflow: hidden; display: flex; flex-direction: column; align-items: center; 
        }

        /* CURSEUR CIBLE */
        #main-container, #info-header {
            cursor: url("data:image/svg+xml;chatset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><circle cx='16' cy='16' r='6' fill='none' stroke='%2300d4ff' stroke-width='2'/><line x1='16' y1='0' x2='16' y2='32' stroke='%2300d4ff' stroke-width='1'/><line x1='0' y1='16' x2='32' y2='16' stroke='%2300d4ff' stroke-width='1'/></svg>") 16 16, crosshair;
        }

        #info-header {
            width: 95%; height: 110px; background: var(--header-bg); color: var(--text);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 5px solid var(--blue); padding: 0 30px; margin-top: 10px;
        }

        .flag-frame { 
            width: 90px; height: 60px; border: 2px solid var(--blue); 
            background: #222; display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        
        #flag-img { width: 100%; height: 100%; object-fit: cover; display: none; z-index: 2; }

        #main-container { display: flex; width: 95%; height: calc(100vh - 150px); margin-top: 20px; position: relative; }
        
        #side-menu { width: 0; background: var(--panel); overflow: hidden; transition: 0.4s ease; color: var(--text); display: flex; flex-direction: column; align-items: center; }
        #side-menu.active { width: 280px; border: 2px solid var(--blue); padding: 20px; }
        
        #toggle-side { 
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            background: var(--blue); border: none; width: 30px; height: 60px; 
            cursor: pointer; display: none; z-index: 2000; font-weight: bold;
        }

        #map-container { flex-grow: 1; border: 2px solid var(--border); background: #000; }
        #map { width: 100%; height: 100%; background: #000 !important; }
        
        #game-over { position: fixed; inset: 0; background: rgba(50, 0, 0, 0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        .timer-text { font-size: 2.8em; color: var(--red); font-weight: bold; }
    </style>
</head>
<body>

<div id="game-over">
    <h1>CONNECTION LOST</h1>
    <button onclick="location.reload()" style="padding: 10px 20px; cursor: pointer;">RETRY</button>
</div>

<div id="info-header">
    <div id="timer-box"><div id="timer" class="timer-text">15</div></div>
    <div class="identity" style="display: flex; align-items: center; flex-grow: 1; padding-left: 30px;">
        <div class="flag-frame" id="frame">
            <img id="flag-img" src="" alt="">
            <span id="flag-fallback" style="font-size: 0.6em; color: #555; position: absolute;">SCANNING</span>
        </div>
        <div id="country-name" style="font-size: 1.6em; margin-left: 20px; text-transform: uppercase;">SELECT COUNTRY</div>
    </div>
    <div id="action-zone"></div>
</div>

<div id="main-container">
    <button id="toggle-side" onclick="toggleSideMenu()">></button>
    <div id="side-menu">
        <span style="color: var(--blue); font-size: 0.8em;">HQ SECTOR ACTIVATED</span>
        <div id="menu-province-name" style="font-size: 1.2em; border-bottom: 2px solid var(--gold); margin-top: 10px; text-align: center; width: 100%;">---</div>
    </div>
    <div id="map-container"><div id="map"></div></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { attributionControl: false, minZoom: 2 }).setView([20, 0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { noWrap: true }).addTo(map);

    let hqLocked = false, selectedLayer = null, hqCountryName = "", timeLeft = 15;
    const flagImg = document.getElementById('flag-img');
    const nameEl = document.getElementById('country-name');
    const actionZone = document.getElementById('action-zone');

    // CHRONO
    const timer = setInterval(() => {
        if (hqLocked) return;
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) { clearInterval(timer); document.getElementById('game-over').style.display = 'flex'; }
    }, 1000);

    // GESTION DES DRAPEAUX (Double Sécurité Intégrée)
    function loadFlag(iso) {
        if (!iso || iso === "-99") {
            flagImg.style.display = "none";
            return;
        }
        
        const code = iso.toUpperCase();
        // Source 1 : SVG (Haute qualité)
        flagImg.src = `https://purecatamphetamine.github.io/country-flag-icons/3x2/${code}.svg`;
        flagImg.style.display = "block";

        // Si Source 1 échoue -> Source 2 : PNG
        flagImg.onerror = () => {
            flagImg.src = `https://flagcdn.com/w160/${iso.toLowerCase()}.png`;
            
            // Si Source 2 échoue -> Cacher
            flagImg.onerror = () => {
                flagImg.style.display = "none";
            };
        };
    }

    // CHARGEMENT CARTE
    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(r => r.json())
    .then(data => {
        L.geoJson(data, {
            style: { fillColor: '#444', fillOpacity: 0.6, color: '#666', weight: 1 },
            onEachFeature: (feature, layer) => {
                layer.on('mouseover', function() { if(!hqLocked) this.setStyle({fillOpacity: 0.9, fillColor: '#888'}); });
                layer.on('mouseout', function() { if(this !== selectedLayer) this.setStyle({fillOpacity: 0.6, fillColor: '#444'}); });
                
                layer.on('click', (e) => {
                    const props = feature.properties;
                    const name = props.ADMIN || props.name;
                    const iso = props.ISO_A2 || props.iso_a2 || "";
                    
                    nameEl.innerText = name;
                    loadFlag(iso);

                    if(!hqLocked) {
                        if(selectedLayer) selectedLayer.setStyle({fillColor:'#444', weight: 1});
                        selectedLayer = layer;
                        layer.setStyle({fillColor:'#666', weight: 2});
                        actionZone.innerHTML = `<button onclick="confirmHQ()" style="background:var(--blue); border:none; padding:12px 25px; font-weight:bold; cursor:pointer; color:black;">ACTIVATE HQ</button>`;
                    }
                });
            }
        }).addTo(map);
    });

    window.confirmHQ = function() {
        hqLocked = true;
        hqCountryName = nameEl.innerText;
        selectedLayer.setStyle({ fillColor: '#00d4ff', color: '#ffd700', weight: 3, fillOpacity: 1 });
        document.getElementById('toggle-side').style.display = 'block';
        document.getElementById('side-menu').classList.add('active');
        document.getElementById('menu-province-name').innerText = hqCountryName;
        actionZone.innerHTML = `<b style="color:var(--blue)">VERIFIED</b>`;
        map.fitBounds(selectedLayer.getBounds());
    };

    window.toggleSideMenu = function() {
        const menu = document.getElementById('side-menu');
        const btn = document.getElementById('toggle-side');
        menu.classList.toggle('active');
        btn.innerText = menu.classList.contains('active') ? "<" : ">";
        btn.style.left = menu.classList.contains('active') ? "280px" : "0";
    };
</script>
</body>
</html>
