<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OpenFront 1918 - Drapeaux Mondiaux & Ressources</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <style>
        /* --- DÃ‰FINITION DES COULEURS (Variables CSS) --- */
        :root { 
            /* Couleurs d'accentuation (restent les mÃªmes) */
            --blue: #00d4ff; --red: #ff3131; --gold: #ffd700; --green: #2ecc71;
            
            /* ThÃ¨me SOMBRE par dÃ©faut */
            --bg: #111; 
            --header-bg: #000; 
            --text: #fff; 
            --panel: #1a1a1a; 
            --panel-inner: #000;
            --border: #333;
            --slider-track: #333;
            
            /* Couleurs Ressources */
            --iron: #bdc3c7; --stone: #7f8c8d; --oil: #2c3e50; --wood: #27ae60; --wheat: #f1c40f;
        }

        /* --- MODE CLAIR (Surcharge les variables) --- */
        body.light-mode {
            --bg: #bdc3c7;
            --header-bg: #ecf0f1;
            --text: #2c3e50;
            --panel: #ffffff;
            --panel-inner: #f7f9f9;
            --border: #bdc3c7;
            --slider-track: #e0e0e0;
            
            /* Ajustement contraste ressources pour fond clair */
            --iron: #7f8c8d; --stone: #596263; --oil: #2c3e50;
        }
        
        * { cursor: crosshair !important; }

        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: background 0.3s, color 0.3s; }

        #info-header {
            width: 100%; height: 120px;
            background: var(--header-bg); color: var(--text);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--blue); box-sizing: border-box; padding: 0 30px; z-index: 1001;
            transition: background 0.3s;
        }

        /* Bouton ThÃ¨me */
        .theme-toggle {
            background: var(--panel); border: 2px solid var(--border);
            color: var(--text); padding: 8px 12px; border-radius: 20px;
            cursor: pointer; font-size: 1.2em; margin-right: 15px;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .theme-toggle:hover { border-color: var(--blue); }

        .flag-frame { 
            width: 110px; height: 80px; 
            border: 2px solid var(--blue); 
            background: #222; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
            font-size: 3.5em; 
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        #flag-emoji { line-height: 1; display: block; cursor: default; }

        #main-view { display: flex; flex-grow: 1; width: 100%; position: relative; overflow: hidden; }
        
        #side-menu { 
            width: 0; background: var(--panel); overflow-y: auto; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s; 
            color: var(--text); display: flex; flex-direction: column; z-index: 1000;
        }
        #side-menu.active { width: 320px; border-right: 2px solid var(--blue); }
        
        .menu-content { width: 300px; padding: 20px; box-sizing: border-box; opacity: 0; transition: 0.3s; }
        #side-menu.active .menu-content { opacity: 1; }

        .money-box { background: var(--panel-inner); padding: 10px; border: 1px dashed var(--gold); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.3s; }
        
        /* Styles Stocks */
        .res-item { display: flex; flex-direction: column; margin: 15px 0; font-size: 0.9em; border-left: 3px solid var(--blue); padding-left: 10px; }
        .res-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 6px; font-weight: bold; }
        .res-bar { width: 100%; height: 10px; background: var(--slider-track); border-radius: 5px; overflow: hidden; }
        .res-fill { height: 100%; transition: width 0.5s ease; }

        .pop-section { margin-top: 30px; padding: 15px; background: var(--panel-inner); border: 1px solid var(--border); border-radius: 8px; transition: background 0.3s; }
        .ratio-container { width: 100%; height: 25px; display: flex; margin: 10px 0; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); }
        .ratio-workers { background: var(--blue); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #000; }
        .ratio-soldiers { background: var(--red); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #fff; }
        
        .worker-dist-section { margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px; }
        .sub-gauge-row { margin-bottom: 12px; }
        .sub-gauge-label { font-size: 0.75em; color: var(--text); opacity: 0.7; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .sub-gauge-track { width: 100%; height: 6px; background: var(--slider-track); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .sub-gauge-fill { height: 100%; transition: width 0.2s ease-out; }
        
        .prio-slider { -webkit-appearance: none; width: 100%; height: 4px; background: var(--slider-track); outline: none; border-radius: 2px; cursor: pointer; }
        .prio-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--blue); cursor: pointer; border: 2px solid #000; }

        #toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: var(--blue); border: none; width: 25px; height: 50px; display: none; z-index: 2000; font-weight: bold; cursor: pointer; border-radius: 0 5px 5px 0; color: #000; }
        
        /* Map container background is handled by Leaflet, but we set a default */
        #map { flex-grow: 1; background: var(--bg) !important; transition: background 0.3s; }
        
        #game-over { position: fixed; inset: 0; background: rgba(20, 0, 0, 0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; }
        .btn-restart { margin-top: 20px; padding: 12px 24px; background: var(--red); border: none; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; }
        
        /* Styles IcÃ´nes Map */
        .resource-icon { 
            text-align: center; line-height: 1;
            filter: drop-shadow(4px 6px 3px rgba(0,0,0,0.8)); 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        /* Ajustement de l'ombre en mode clair via CSS global si besoin, mais ici SVG ok */
        .resource-icon:hover { transform: scale(1.4) translateY(-8px); z-index: 2000 !important; }
        
        #btn-hq {
            background: linear-gradient(135deg, var(--blue) 0%, #0099cc 100%); 
            border: 2px solid #fff; padding: 12px 24px; font-weight: 800; color: white; cursor: pointer; border-radius: 6px;
            font-size: 1.1em; transition: 0.2s; box-shadow: 0 0 15px var(--blue); text-transform: uppercase; letter-spacing: 1px;
        }
        #btn-hq:hover { background: #fff; color: var(--blue); transform: scale(1.05); }
    </style>
</head>
<body>

<div id="game-over">
    <h1 style="font-size: 3em; margin-bottom: 10px;">MISSION INTERROMPUE</h1>
    <p>Le temps imparti pour le dÃ©ploiement a expirÃ©.</p>
    <button class="btn-restart" onclick="location.reload()">RÃ‰ESSAYER</button>
</div>

<header id="info-header">
    <div style="display:flex; align-items:center;">
        <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thÃ¨me">
            <span id="theme-icon">â˜€ï¸</span>
        </button>
        <div id="timer" style="font-size: 2.5em; color: var(--red); font-weight: bold; width: 60px;">15</div>
    </div>
    
    <div style="display: flex; align-items: center; flex-grow: 1; margin-left: 30px;">
        <div class="flag-frame"><span id="flag-emoji">ğŸŒ</span></div>
        <div id="country-name" style="font-size: 1.8em; margin-left: 20px; font-weight: bold; letter-spacing: 1px;">INITIALISATION...</div>
    </div>
    <div id="action-zone"></div>
</header>

<div id="main-view">
    <div id="side-menu">
        <div class="menu-content">
            <h3 style="color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px; margin-bottom: 15px;">GESTION DU TERRITOIRE</h3>
            <div id="hq-name" style="color: var(--green); margin-bottom: 20px; font-weight: bold;">---</div>

            <div class="money-box">
                <span style="font-size: 1.5em;">ğŸ’°</span>
                <div style="text-align: left;">
                    <div style="font-size: 0.7em; color: var(--gold); font-weight: bold;">BUDGET NATIONAL</div>
                    <div id="money-val" style="font-size: 1.3em; font-family: monospace;">--- $</div>
                </div>
            </div>

            <div id="inventory">
                <div style="font-size: 0.7em; color: var(--gold); margin-bottom: 10px; font-weight: bold;">RÃ‰SERVES D'Ã‰TAT (Max 1000 T)</div>
                <div class="res-item"><div class="res-header"><span>Stock Fer</span><span id="val-fer" style="color: var(--iron);">-- T</span></div><div class="res-bar"><div id="stock-fer" class="res-fill" style="width: 0%; background: var(--iron);"></div></div></div>
                <div class="res-item"><div class="res-header"><span>Stock PÃ©trole</span><span id="val-oil" style="color: var(--oil);">-- T</span></div><div class="res-bar"><div id="stock-oil" class="res-fill" style="width: 0%; background: var(--oil);"></div></div></div>
                <div class="res-item"><div class="res-header"><span>Stock Pierre</span><span id="val-stone" style="color: var(--stone);">-- T</span></div><div class="res-bar"><div id="stock-stone" class="res-fill" style="width: 0%; background: var(--stone);"></div></div></div>
                <div class="res-item"><div class="res-header"><span>Stock Bois</span><span id="val-wood" style="color: var(--wood);">-- T</span></div><div class="res-bar"><div id="stock-wood" class="res-fill" style="width: 0%; background: var(--wood);"></div></div></div>
                <div class="res-item"><div class="res-header"><span>Stock BlÃ©</span><span id="val-wheat" style="color: var(--wheat);">-- T</span></div><div class="res-bar"><div id="stock-wheat" class="res-fill" style="width: 0%; background: var(--wheat);"></div></div></div>
            </div>

            <div class="pop-section">
                <div style="font-size: 0.8em; color: var(--blue); margin-bottom: 10px; font-weight: bold;">POPULATION TOTALE</div>
                <div class="ratio-container">
                    <div id="workers-bar" class="ratio-workers" style="width: 70%;">TRAVAIL</div>
                    <div id="soldiers-bar" class="ratio-soldiers" style="width: 30%;">ARMÃ‰E</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7em; margin-top: 8px;">
                    <span id="pop-total">Pop: ---</span>
                    <span id="mobilization-text" style="color: var(--red); font-weight: bold;">Mobilisation: 30%</span>
                </div>
                <input type="range" min="0" max="100" value="30" style="width:100%; margin-top:15px;" oninput="updateMainRatio(this.value)">

                <div class="worker-dist-section">
                    <div style="font-size: 0.75em; color: var(--text); margin-bottom: 12px; font-weight: bold; border-left: 3px solid var(--gold); padding-left: 8px;">AFFECTATION DES TRAVAILLEURS</div>
                    <div class="sub-gauge-row"><div class="sub-gauge-label"><span>â›ï¸ Fer</span><span id="txt-fer" style="color:var(--iron)">0%</span></div><div class="sub-gauge-track"><div id="gauge-fer" class="sub-gauge-fill" style="background: var(--iron); width: 0%;"></div></div><input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()"></div>
                    <div class="sub-gauge-row"><div class="sub-gauge-label"><span>ğŸ›¢ï¸ PÃ©trole</span><span id="txt-oil" style="color: #4a69bd">0%</span></div><div class="sub-gauge-track"><div id="gauge-oil" class="sub-gauge-fill" style="background: var(--oil); width: 0%;"></div></div><input type="range" class="prio-slider" min="0" max="100" value="10" oninput="updateWorkerDistribution()"></div>
                    <div class="sub-gauge-row"><div class="sub-gauge-label"><span>ğŸ§± Pierre</span><span id="txt-stone" style="color:var(--stone)">0%</span></div><div class="sub-gauge-track"><div id="gauge-stone" class="sub-gauge-fill" style="background: var(--stone); width: 0%;"></div></div><input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()"></div>
                    <div class="sub-gauge-row"><div class="sub-gauge-label"><span>ğŸŒ² ForÃªt</span><span id="txt-wood" style="color:var(--wood)">0%</span></div><div class="sub-gauge-track"><div id="gauge-wood" class="sub-gauge-fill" style="background: var(--wood); width: 0%;"></div></div><input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()"></div>
                    <div class="sub-gauge-row"><div class="sub-gauge-label"><span>ğŸŒ¾ BlÃ©</span><span id="txt-wheat" style="color:var(--wheat)">0%</span></div><div class="sub-gauge-track"><div id="gauge-wheat" class="sub-gauge-fill" style="background: var(--wheat); width: 0%;"></div></div><input type="range" class="prio-slider" min="0" max="100" value="30" oninput="updateWorkerDistribution()"></div>
                    <div style="font-size: 0.65em; color: var(--text); opacity:0.6; margin-top: 5px; text-align: right;">Total Travailleurs: 100%</div>
                </div>
            </div>
        </div>
    </div>
    <button id="toggle-btn" onclick="toggleMenu()">></button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- GESTION DU THÃˆME ---
    const mapEl = document.getElementById('map');
    let isLightMode = false;
    let currentTileLayer;
    
    // URLs des tuiles
    const darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png';
    const lightTiles = 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';

    // Initialisation Carte
    const map = L.map('map', { attributionControl: false, zoomControl: false, minZoom: 2, maxBounds: [[-90, -180], [90, 180]] }).setView([20, 0], 2);
    
    // Ajout de la couche par dÃ©faut (Sombre)
    currentTileLayer = L.tileLayer(darkTiles, { noWrap: true }).addTo(map);

    function toggleTheme() {
        isLightMode = !isLightMode;
        document.body.classList.toggle('light-mode');
        
        // Changer l'icÃ´ne du bouton
        document.getElementById('theme-icon').innerText = isLightMode ? "ğŸŒ‘" : "â˜€ï¸";
        
        // Changer les tuiles de la carte
        map.removeLayer(currentTileLayer);
        currentTileLayer = L.tileLayer(isLightMode ? lightTiles : darkTiles, { noWrap: true }).addTo(map);
        
        // Mettre Ã  jour le style des pays si dÃ©jÃ  chargÃ©s
        if(geojsonLayer) {
            geojsonLayer.setStyle(getCountryStyle);
            // Si un pays est sÃ©lectionnÃ©, rÃ©appliquer le style de sÃ©lection
            if(selectedLayer) {
                selectedLayer.setStyle({
                    weight: 3,
                    color: '#00d4ff',
                    fillOpacity: isLightMode ? 0.6 : 0.4,
                    dashArray: ''
                });
            }
        }
    }

    // Style dynamique des pays selon le mode
    function getCountryStyle(feature) {
        return {
            fillColor: isLightMode ? '#95a5a6' : '#2c3e50', // Gris clair vs Gris foncÃ©
            weight: 1,
            opacity: 1,
            color: isLightMode ? '#7f8c8d' : '#111', // Bordures
            dashArray: '3',
            fillOpacity: isLightMode ? 0.3 : 0.2
        };
    }

    let hqLocked = false, selectedLayer = null, timeLeft = 15, currentArea = 0;
    const flagDisplay = document.getElementById('flag-emoji');
    const countryDisplay = document.getElementById('country-name');
    let currentWorkerPct = 70; 
    let currentPopulationMillions = 0.5;
    let resourceLayers = L.layerGroup().addTo(map);

    const flagMap = { "Afghanistan": "ğŸ‡¦ğŸ‡«", "Albania": "ğŸ‡¦ğŸ‡±", "Algeria": "ğŸ‡©ğŸ‡¿", "Andorra": "ğŸ‡¦ğŸ‡©", "Angola": "ğŸ‡¦ğŸ‡´", "Antigua and Barbuda": "ğŸ‡¦ğŸ‡¬", "Argentina": "ğŸ‡¦ğŸ‡·", "Armenia": "ğŸ‡¦ğŸ‡²", "Australia": "ğŸ‡¦ğŸ‡º", "Austria": "ğŸ‡¦ğŸ‡¹", "Azerbaijan": "ğŸ‡¦ğŸ‡¿", "Bahamas": "ğŸ‡§ğŸ‡¸", "Bahrain": "ğŸ‡§ğŸ‡­", "Bangladesh": "ğŸ‡§ğŸ‡©", "Barbados": "ğŸ‡§ğŸ‡§", "Belarus": "ğŸ‡§ğŸ‡¾", "Belgium": "ğŸ‡§ğŸ‡ª", "Belize": "ğŸ‡§ğŸ‡¿", "Benin": "ğŸ‡§ğŸ‡¯", "Bhutan": "ğŸ‡§ğŸ‡¹", "Bolivia": "ğŸ‡§ğŸ‡´", "Bosnia and Herzegovina": "ğŸ‡§ğŸ‡¦", "Botswana": "ğŸ‡§ğŸ‡¼", "Brazil": "ğŸ‡§ğŸ‡·", "Brunei": "ğŸ‡§ğŸ‡³", "Bulgaria": "ğŸ‡§ğŸ‡¬", "Burkina Faso": "ğŸ‡§ğŸ‡«", "Burundi": "ğŸ‡§ğŸ‡®", "Cabo Verde": "ğŸ‡¨ğŸ‡»", "Cambodia": "ğŸ‡°ğŸ‡­", "Cameroon": "ğŸ‡¨ğŸ‡²", "Canada": "ğŸ‡¨ğŸ‡¦", "Central African Republic": "ğŸ‡¨ğŸ‡«", "Chad": "ğŸ‡¹ğŸ‡©", "Chile": "ğŸ‡¨ğŸ‡±", "China": "ğŸ‡¨ğŸ‡³", "Colombia": "ğŸ‡¨ğŸ‡´", "Comoros": "ğŸ‡°ğŸ‡²", "Republic of the Congo": "ğŸ‡¨ğŸ‡¬", "Democratic Republic of the Congo": "ğŸ‡¨ğŸ‡©", "Costa Rica": "ğŸ‡¨ğŸ‡·", "Croatia": "ğŸ‡­ğŸ‡·", "Cuba": "ğŸ‡¨ğŸ‡º", "Cyprus": "ğŸ‡¨ğŸ‡¾", "Czech Republic": "ğŸ‡¨ğŸ‡¿", "Denmark": "ğŸ‡©ğŸ‡°", "Djibouti": "ğŸ‡©á´Š", "Dominica": "ğŸ‡©ğŸ‡²", "Dominican Republic": "ğŸ‡©ğŸ‡´", "East Timor": "ğŸ‡¹ğŸ‡±", "Ecuador": "ğŸ‡ªğŸ‡¨", "Egypt": "ğŸ‡ªğŸ‡¬", "El Salvador": "ğŸ‡¸ğŸ‡»", "Equatorial Guinea": "ğŸ‡¬ğŸ‡¶", "Eritrea": "ğŸ‡ªğŸ‡·", "Estonia": "ğŸ‡ªğŸ‡ª", "Eswatini": "ğŸ‡¸ğŸ‡¿", "Ethiopia": "ğŸ‡ªğŸ‡¹", "Fiji": "ğŸ‡«ğŸ‡¯", "Finland": "ğŸ‡«ğŸ‡®", "France": "ğŸ‡«ğŸ‡·", "Gabon": "ğŸ‡¬ğŸ‡¦", "Gambia": "ğŸ‡¬ğŸ‡²", "Georgia": "ğŸ‡¬ğŸ‡ª", "Germany": "ğŸ‡©ğŸ‡ª", "Ghana": "ğŸ‡¬ğŸ‡­", "Greece": "ğŸ‡¬ğŸ‡·", "Grenada": "ğŸ‡¬ğŸ‡©", "Guatemala": "ğŸ‡¬ğŸ‡¹", "Guinea": "ğŸ‡¬ğŸ‡³", "Guinea-Bissau": "ğŸ‡¬ğŸ‡¼", "Guyana": "ğŸ‡¬ğŸ‡¾", "Haiti": "ğŸ‡­ğŸ‡¹", "Honduras": "ğŸ‡­ğŸ‡³", "Hungary": "ğŸ‡­ğŸ‡º", "Iceland": "ğŸ‡®ğŸ‡¸", "India": "ğŸ‡®ğŸ‡³", "Indonesia": "ğŸ‡®ğŸ‡©", "Iran": "ğŸ‡®ğŸ‡·", "Iraq": "ğŸ‡®ğŸ‡¶", "Ireland": "ğŸ‡®ğŸ‡ª", "Israel": "ğŸ‡®ğŸ‡±", "Italy": "ğŸ‡®ğŸ‡¹", "Ivory Coast": "ğŸ‡¨ğŸ‡®", "Jamaica": "ğŸ‡¯ğŸ‡²", "Japan": "ğŸ‡¯ğŸ‡µ", "Jordan": "ğŸ‡¯ğŸ‡´", "Kazakhstan": "ğŸ‡°ğŸ‡¿", "Kenya": "ğŸ‡°ğŸ‡ª", "Kiribati": "ğŸ‡°ğŸ‡®", "Kosovo": "ğŸ‡½ğŸ‡°", "Kuwait": "ğŸ‡°ğŸ‡¼", "Kyrgyzstan": "ğŸ‡°ğŸ‡¬", "Laos": "ğŸ‡±ğŸ‡¦", "Latvia": "ğŸ‡±ğŸ‡»", "Lebanon": "ğŸ‡±ğŸ‡§", "Lesotho": "ğŸ‡±ğŸ‡¸", "Liberia": "ğŸ‡±ğŸ‡·", "Libya": "ğŸ‡±ğŸ‡¾", "Liechtenstein": "ğŸ‡±ğŸ‡®", "Lithuania": "ğŸ‡±ğŸ‡¹", "Luxembourg": "ğŸ‡±ğŸ‡º", "Madagascar": "ğŸ‡²ğŸ‡¬", "Malawi": "ğŸ‡²ğŸ‡¼", "Malaysia": "ğŸ‡²ğŸ‡¾", "Maldives": "ğŸ‡²ğŸ‡»", "Mali": "ğŸ‡²ğŸ‡±", "Malta": "ğŸ‡²ğŸ‡¹", "Marshall Islands": "ğŸ‡²ğŸ‡­", "Mauritania": "ğŸ‡²ğŸ‡·", "Mauritius": "ğŸ‡²ğŸ‡º", "Mexico": "ğŸ‡²ğŸ‡½", "Micronesia": "ğŸ‡«ğŸ‡²", "Moldova": "ğŸ‡²ğŸ‡©", "Monaco": "ğŸ‡²ğŸ‡¨", "Mongolia": "ğŸ‡²ğŸ‡³", "Montenegro": "ğŸ‡²ğŸ‡ª", "Morocco": "ğŸ‡²ğŸ‡¦", "Mozambique": "ğŸ‡²ğŸ‡¿", "Myanmar": "ğŸ‡²ğŸ‡²", "Namibia": "ğŸ‡³ğŸ‡¦", "Nauru": "ğŸ‡³ğŸ‡·", "Nepal": "ğŸ‡³ğŸ‡µ", "Netherlands": "ğŸ‡³ğŸ‡±", "New Zealand": "ğŸ‡³ğŸ‡¿", "Nicaragua": "ğŸ‡³ğŸ‡®", "Niger": "ğŸ‡³ğŸ‡ª", "Nigeria": "ğŸ‡³ğŸ‡¬", "North Korea": "ğŸ‡°ğŸ‡µ", "North Macedonia": "ğŸ‡²ğŸ‡°", "Norway": "ğŸ‡³ğŸ‡´", "Oman": "ğŸ‡´ğŸ‡²", "Pakistan": "ğŸ‡µğŸ‡°", "Palau": "ğŸ‡µğŸ‡¼", "Palestine": "ğŸ‡µğŸ‡¸", "Panama": "ğŸ‡µğŸ‡¦", "Papua New Guinea": "ğŸ‡µğŸ‡¬", "Paraguay": "ğŸ‡µğŸ‡¾", "Peru": "ğŸ‡µğŸ‡ª", "Philippines": "ğŸ‡µğŸ‡­", "Poland": "ğŸ‡µğŸ‡±", "Portugal": "ğŸ‡µğŸ‡¹", "Qatar": "ğŸ‡¶ğŸ‡¦", "Romania": "ğŸ‡·ğŸ‡´", "Russia": "ğŸ‡·ğŸ‡º", "Rwanda": "ğŸ‡·ğŸ‡¼", "Saint Kitts and Nevis": "ğŸ‡°ğŸ‡³", "Saint Lucia": "ğŸ‡±ğŸ‡¨", "Saint Vincent and the Grenadines": "ğŸ‡»ğŸ‡¨", "Samoa": "ğŸ‡¼ğŸ‡¸", "San Marino": "ğŸ‡¸ğŸ‡²", "Sao Tome and Principe": "ğŸ‡¸ğŸ‡¹", "Saudi Arabia": "ğŸ‡¸ğŸ‡¦", "Senegal": "ğŸ‡¸ğŸ‡³", "Serbia": "ğŸ‡·ğŸ‡¸", "Seychelles": "ğŸ‡¸ğŸ‡¨", "Sierra Leone": "ğŸ‡¸ğŸ‡±", "Singapore": "ğŸ‡¸ğŸ‡¬", "Slovakia": "ğŸ‡¸ğŸ‡°", "Slovenia": "ğŸ‡¸ğŸ‡®", "Solomon Islands": "ğŸ‡¸ğŸ‡§", "Somalia": "ğŸ‡¸ğŸ‡´", "South Africa": "ğŸ‡¿ğŸ‡¦", "South Korea": "ğŸ‡°ğŸ‡·", "South Sudan": "ğŸ‡¸ğŸ‡¸", "Spain": "ğŸ‡ªğŸ‡¸", "Sri Lanka": "ğŸ‡±ğŸ‡°", "Sudan": "ğŸ‡¸ğŸ‡©", "Suriname": "ğŸ‡¸ğŸ‡·", "Sweden": "ğŸ‡¸ğŸ‡ª", "Switzerland": "ğŸ‡¨ğŸ‡­", "Syria": "ğŸ‡¸ğŸ‡¾", "Taiwan": "ğŸ‡¹ğŸ‡¼", "Tajikistan": "ğŸ‡¹ğŸ‡¯", "Tanzania": "ğŸ‡¹ğŸ‡¿", "Thailand": "ğŸ‡¹ğŸ‡­", "Timor-Leste": "ğŸ‡¹ğŸ‡±", "Togo": "ğŸ‡¹ğŸ‡¬", "Tonga": "ğŸ‡¹ğŸ‡´", "Trinidad and Tobago": "ğŸ‡¹ğŸ‡¹", "Tunisia": "ğŸ‡¹ğŸ‡³", "Turkey": "ğŸ‡¹ğŸ‡·", "Turkmenistan": "ğŸ‡¹ğŸ‡²", "Tuvalu": "ğŸ‡¹ğŸ‡»", "Uganda": "ğŸ‡ºğŸ‡¬", "Ukraine": "ğŸ‡ºğŸ‡¦", "United Arab Emirates": "ğŸ‡¦ğŸ‡ª", "United Kingdom": "ğŸ‡¬ğŸ‡§", "United States of America": "ğŸ‡ºğŸ‡¸", "Uruguay": "ğŸ‡ºğŸ‡¾", "Uzbekistan": "ğŸ‡ºğŸ‡¿", "Vanuatu": "ğŸ‡»ğŸ‡º", "Vatican": "ğŸ‡»ğŸ‡¦", "Venezuela": "ğŸ‡»ğŸ‡ª", "Vietnam": "ğŸ‡»ğŸ‡³", "Yemen": "ğŸ‡¾ğŸ‡ª", "Zambia": "ğŸ‡¿ğŸ‡²", "Zimbabwe": "ğŸ‡¿ğŸ‡¼", "Somaliland": "ğŸ´â€â˜ ï¸", "Greenland": "ğŸ‡¬ğŸ‡±", "Western Sahara": "ğŸ‡ªğŸ‡­", "Falkland Islands": "ğŸ‡«ğŸ‡°", "Antarctica": "ğŸ‡¦ğŸ‡¶" };

    const surfaceData = { "Russia": 17098242, "Canada": 9984670, "United States of America": 9833517, "China": 9596960, "Brazil": 8515767, "Australia": 7692024, "India": 3287263, "Argentina": 2780400, "Kazakhstan": 2724900, "Algeria": 2381741, "Democratic Republic of the Congo": 2344858, "Greenland": 2166086, "Saudi Arabia": 2149690, "Mexico": 1964375, "Indonesia": 1904569, "Sudan": 1861484, "Libya": 1759540, "Iran": 1648195, "Mongolia": 1564110, "Peru": 1285216, "Chad": 1284000, "Niger": 1267000, "Angola": 1246700, "Mali": 1240192, "South Africa": 1219090, "Colombia": 1141748, "Ethiopia": 1104300, "Bolivia": 1098581, "Mauritania": 1030700, "Egypt": 1002450, "Tanzania": 945087, "Nigeria": 923768, "Venezuela": 916445, "Pakistan": 881912, "Namibia": 825615, "Mozambique": 801590, "Turkey": 783562, "Chile": 756102, "Zambia": 752612, "Myanmar": 676578, "Afghanistan": 652230, "South Sudan": 644329, "France": 643801, "Somalia": 637657, "Central African Republic": 622984, "Ukraine": 603628, "Madagascar": 587041, "Botswana": 581730, "Kenya": 580367, "Yemen": 527968, "Thailand": 513120, "Spain": 505992, "Turkmenistan": 488100, "Cameroon": 475442, "Papua New Guinea": 462840, "Sweden": 450295, "Uzbekistan": 447400, "Morocco": 446550, "Iraq": 438317, "Paraguay": 406752, "Zimbabwe": 390757, "Norway": 385207, "Japan": 377975, "Germany": 357022, "Republic of the Congo": 342000, "Finland": 338424, "Vietnam": 331210, "Malaysia": 330803, "Ivory Coast": 322463, "Poland": 312696, "Oman": 309500, "Italy": 301340, "Philippines": 300000, "Ecuador": 283561, "Burkina Faso": 272967, "New Zealand": 268021, "Gabon": 267668, "Guinea": 245857, "United Kingdom": 242495, "Uganda": 241038, "Ghana": 238533, "Romania": 238391, "Laos": 236800, "Guyana": 214969, "Belarus": 207600, "Kyrgyzstan": 199951, "Senegal": 196722, "Syria": 185180, "Cambodia": 181035, "Somaliland": 176120, "Uruguay": 176215, "Suriname": 163820, "Tunisia": 163610, "Bangladesh": 147570, "Nepal": 147181, "Tajikistan": 143100, "Greece": 131957, "Nicaragua": 130373, "North Korea": 120538, "Malawi": 118484, "Eritrea": 117600, "Benin": 114763, "Honduras": 112492, "Liberia": 111369, "Bulgaria": 110879, "Cuba": 109884, "Guatemala": 108889, "Iceland": 103000, "South Korea": 100210, "Hungary": 93028, "Portugal": 92090, "Jordan": 89342, "Azerbaijan": 86600, "Austria": 83871, "United Arab Emirates": 83600, "Czech Republic": 78865, "Serbia": 77474, "Panama": 75417, "Sierra Leone": 71740, "Ireland": 70273, "Georgia": 69700, "Sri Lanka": 65610, "Lithuania": 65300, "Latvia": 64589, "Togo": 56785, "Croatia": 56594, "Bosnia and Herzegovina": 51197, "Costa Rica": 51100, "Slovakia": 49035, "Dominican Republic": 48671, "Estonia": 45227, "Denmark": 42933, "Netherlands": 41543, "Switzerland": 41284, "Bhutan": 38394, "Taiwan": 36193, "Guinea-Bissau": 36125, "Moldova": 33846, "Belgium": 30528, "Lesotho": 30355, "Armenia": 29743, "Solomon Islands": 28896, "Albania": 28748, "Equatorial Guinea": 28051, "Burundi": 27834, "Haiti": 27750, "Rwanda": 26338, "North Macedonia": 25713, "Djibouti": 23200, "Belize": 22966, "El Salvador": 21041, "Israel": 20770, "Slovenia": 20273, "Fiji": 18274, "Kuwait": 17818, "Eswatini": 17364, "East Timor": 14874, "Bahamas": 13943, "Montenegro": 13812, "Vanuatu": 12189, "Qatar": 11586, "Gambia": 11295, "Jamaica": 10991, "Lebanon": 10452, "Cyprus": 9251, "Baykonur Cosmodrome": 6717, "Palestine": 6020, "Brunei": 5765, "Trinidad and Tobago": 5130, "Cabo Verde": 4033, "Samoa": 2842, "Luxembourg": 2586, "Mauritius": 2040, "Comoros": 1862, "Sao Tome and Principe": 964, "Kiribati": 811, "Bahrain": 778, "Dominica": 751, "Tonga": 747, "Singapore": 728, "Micronesia": 702, "Saint Lucia": 616, "Andorra": 468, "Palau": 459, "Seychelles": 452, "Antigua and Barbuda": 442, "Barbados": 430, "Saint Vincent and the Grenadines": 389, "Grenada": 344, "Malta": 316, "Maldives": 300, "Saint Kitts and Nevis": 261, "Marshall Islands": 181, "Liechtenstein": 160, "San Marino": 61, "Tuvalu": 26, "Nauru": 21, "Monaco": 2, "Vatican": 0.49, "Antarctica": 14000000 };

    window.updateMainRatio = function(val) {
        const soldierPct = parseInt(val);
        currentWorkerPct = 100 - soldierPct;
        document.getElementById('soldiers-bar').style.width = soldierPct + "%";
        document.getElementById('workers-bar').style.width = currentWorkerPct + "%";
        document.getElementById('mobilization-text').innerText = "Mobilisation: " + soldierPct + "%";
        window.updateWorkerDistribution();
    };

    function formatPopNumber(valMillions) {
        if (valMillions < 1) {
            return Math.round(valMillions * 1000000).toLocaleString('fr-FR');
        }
        return valMillions.toFixed(1) + "M";
    }

    window.updateWorkerDistribution = function() {
        const sliders = document.querySelectorAll('.prio-slider');
        const weights = Array.from(sliders).map(s => parseInt(s.value));
        const totalWeight = weights.reduce((a, b) => a + b, 0) || 1; 
        const totalWorkersAvailable = currentPopulationMillions * (currentWorkerPct / 100);
        const resourceIds = ['fer', 'oil', 'stone', 'wood', 'wheat'];
        weights.forEach((weight, index) => {
            const id = resourceIds[index];
            const relativePct = (weight / totalWeight); 
            const displayPct = Math.round(relativePct * 100);
            const workersForResource = totalWorkersAvailable * relativePct;
            const workersFormatted = formatPopNumber(workersForResource);
            const visualWidth = relativePct * 100;
            document.getElementById(`gauge-${id}`).style.width = visualWidth + "%";
            document.getElementById(`txt-${id}`).innerText = `${displayPct}% (${workersFormatted})`;
        });
    };

    window.updateMainRatio(30);

    window.gameTimer = setInterval(() => {
        if (hqLocked) return;
        timeLeft--;
        const timerEl = document.getElementById('timer');
        if(timerEl) timerEl.innerText = timeLeft;
        if (timeLeft <= 0) { 
            clearInterval(window.gameTimer); 
            document.getElementById('game-over').style.display = 'flex'; 
        }
    }, 1000);

    function getFlagEmoji(isoCode, countryName) {
        if (flagMap[countryName]) return flagMap[countryName];
        if (isoCode && isoCode !== "-99" && isoCode.length === 2) {
            const code = isoCode.toUpperCase();
            return String.fromCodePoint(...[...code].map(c => c.charCodeAt(0) + 127397));
        }
        return "ğŸŒ"; 
    }

    function getArea(countryName, layer) {
        if (surfaceData[countryName]) return surfaceData[countryName];
        const bounds = layer.getBounds();
        let width = Math.abs(bounds.getEast() - bounds.getWest());
        const height = Math.abs(bounds.getNorth() - bounds.getSouth());
        if (width > 200) width = 360 - width; 
        return (width * 111) * (height * 111);
    }

    function calculateBudget(area) {
        const minArea = 0.49; const maxArea = 17098242; const minBudget = 200000; const maxBudget = 5000000;   
        const safeArea = Math.max(minArea, area);
        const ratio = (Math.log(safeArea) - Math.log(minArea)) / (Math.log(maxArea) - Math.log(minArea));
        let money = maxBudget - (ratio * (maxBudget - minBudget));
        return Math.round(money / 1000) * 1000; 
    }

    function calculateResource(area, minRes, maxRes) {
        const minArea = 0.49; const maxArea = 17098242;
        const safeArea = Math.max(minArea, area);
        const ratio = (Math.log(safeArea) - Math.log(minArea)) / (Math.log(maxArea) - Math.log(minArea));
        let amount = maxRes - (ratio * (maxRes - minRes));
        return Math.round(amount * 100) / 100;
    }

    function generateResourceZones(layer, area) {
        resourceLayers.clearLayers();
        let numZones = Math.floor(10 + Math.pow(area, 0.18)); 
        numZones = Math.max(10, Math.min(50, numZones));

        const types = [
            { id: 'fer', icon: `<svg viewBox="0 0 64 64" width="56" height="56" style="filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.6));"><defs><linearGradient id="mtnGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#cfd8dc"/><stop offset="100%" stop-color="#546e7a"/></linearGradient><linearGradient id="woodGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#a1887f"/><stop offset="100%" stop-color="#5d4037"/></linearGradient></defs><path d="M4 60 L16 35 L32 10 L48 35 L60 60 Z" fill="url(#mtnGrad)" stroke="#455a64" stroke-width="2"/><path d="M22 60 V38 A10 10 0 0 1 42 38 V60 Z" fill="#263238"/><path d="M20 60 V38" stroke="url(#woodGrad)" stroke-width="4" stroke-linecap="round"/><path d="M44 60 V38" stroke="url(#woodGrad)" stroke-width="4" stroke-linecap="round"/><path d="M18 38 H46" stroke="url(#woodGrad)" stroke-width="4" stroke-linecap="round"/><path d="M26 60 L24 64 M38 60 L40 64" stroke="#212121" stroke-width="2"/><path d="M22 62 H42" stroke="#3e2723" stroke-width="2"/><rect x="26" y="50" width="12" height="8" fill="#455a64" stroke="#000" stroke-width="1"/><circle cx="28" cy="58" r="2" fill="#000"/><circle cx="36" cy="58" r="2" fill="#000"/><rect x="27" y="51" width="10" height="3" fill="#cfd8dc"/></svg>` },
            { id: 'oil', icon: `<svg viewBox="0 0 64 64" width="56" height="56" style="filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.6));"><defs><linearGradient id="metalGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#b0bec5"/><stop offset="100%" stop-color="#455a64"/></linearGradient></defs><rect x="10" y="54" width="44" height="6" fill="#78909c" stroke="#37474f"/><path d="M28 54 L32 25 L36 54" fill="none" stroke="#37474f" stroke-width="3"/><path d="M10 32 L54 22" stroke="#c62828" stroke-width="4" stroke-linecap="round"/><path d="M10 32 L10 45" stroke="#37474f" stroke-width="1"/><rect x="8" y="45" width="4" height="6" fill="#37474f"/><rect x="50" y="18" width="8" height="10" fill="#546e7a" stroke="#000"/><path d="M54 28 V54" stroke="#000" stroke-width="1"/><path d="M46 58 v-6 c0-1 2-2 4-2 s4 1 4 2 v6 c0 1-2 2-4 2 s-4-1-4-2 z" fill="#c0392b" stroke="#000" stroke-width="0.5"/><path d="M54 54 v-6 c0-1 2-2 4-2 s4 1 4 2 v6 c0 1-2 2-4 2 s-4-1-4-2 z" fill="#c0392b" stroke="#000" stroke-width="0.5"/></svg>` },
            { id: 'stone', icon: `<svg viewBox="0 0 64 64" width="56" height="56" style="filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.6));"><defs><linearGradient id="groundGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#d7ccc8"/><stop offset="100%" stop-color="#8d6e63"/></linearGradient></defs><path d="M2 60 L14 14 L50 14 L62 60 Z" fill="url(#groundGrad)"/><path d="M12 60 L20 28 L44 28 L52 60 Z" fill="#bcaaa4"/><path d="M22 60 L28 42 L36 42 L42 60 Z" fill="#8d6e63"/><circle cx="16" cy="54" r="4" fill="#6d4c41"/><circle cx="48" cy="52" r="5" fill="#5d4037"/><circle cx="50" cy="20" r="3" fill="#795548"/><path d="M4 60 H60" stroke="#3e2723" stroke-width="2"/><path d="M50 55 l2 -2 l3 1 l-1 3 z" fill="#7f8c8d"/><path d="M56 50 l3 -3 l2 2 l-2 2 z" fill="#95a5a6"/><line x1="50" y1="14" x2="50" y2="40" stroke="#212121" stroke-width="1"/><line x1="50" y1="14" x2="35" y2="30" stroke="#212121" stroke-width="1"/></svg>` },
            { id: 'wood', icon: `<svg viewBox="0 0 64 64" width="56" height="56" style="filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.6));"><defs><linearGradient id="forestGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#2e7d32"/><stop offset="100%" stop-color="#1b5e20"/></linearGradient></defs><path d="M10 45 L20 20 L30 45 Z" fill="#1b5e20"/><path d="M34 45 L44 20 L54 45 Z" fill="#1b5e20"/><path d="M22 40 L32 15 L42 40 Z" fill="#2e7d32"/><path d="M4 55 L14 25 L24 55 Z" fill="#43a047"/><rect x="12" y="55" width="4" height="6" fill="#3e2723"/><path d="M40 55 L50 25 L60 55 Z" fill="#43a047"/><rect x="48" y="55" width="4" height="6" fill="#3e2723"/><path d="M20 58 L32 22 L44 58 Z" fill="#66bb6a"/><rect x="30" y="58" width="4" height="6" fill="#3e2723"/><circle cx="10" cy="58" r="3" fill="#5d4037"/><circle cx="16" cy="58" r="3" fill="#5d4037"/></svg>` },
            { id: 'wheat', icon: `<svg viewBox="0 0 64 64" width="56" height="56" style="filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.6));"><defs><linearGradient id="wheatGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ffd54f"/><stop offset="100%" stop-color="#ff6f00"/></linearGradient></defs><ellipse cx="32" cy="58" rx="28" ry="6" fill="#5d4037"/><path d="M10 58 Q15 40 10 25" stroke="#ffb300" stroke-width="2" fill="none"/><path d="M14 58 Q19 40 14 28" stroke="#ffb300" stroke-width="2" fill="none"/><path d="M50 58 Q45 40 50 25" stroke="#ffb300" stroke-width="2" fill="none"/><path d="M46 58 Q41 40 46 28" stroke="#ffb300" stroke-width="2" fill="none"/><path d="M20 56 V35 L32 25 L44 35 V56 Z" fill="#b71c1c" stroke="#3e2723" stroke-width="1"/><path d="M32 25 L20 35 H44 Z" fill="#e53935"/><rect x="28" y="42" width="8" height="14" fill="#3e2723"/><path d="M28 42 L32 56 L36 42" stroke="#5d4037" stroke-width="1"/><path d="M26 60 Q20 40 22 30" stroke="url(#wheatGrad)" stroke-width="3" fill="none"/><ellipse cx="22" cy="30" rx="3" ry="6" fill="#ffd54f"/><path d="M38 60 Q44 40 42 30" stroke="url(#wheatGrad)" stroke-width="3" fill="none"/><ellipse cx="42" cy="30" rx="3" ry="6" fill="#ffd54f"/><path d="M32 60 Q32 40 32 28" stroke="url(#wheatGrad)" stroke-width="3" fill="none"/><ellipse cx="32" cy="28" rx="3" ry="7" fill="#ffd54f"/></svg>` }
        ];

        const bounds = layer.getBounds();
        const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
        const polygonFeature = layer.toGeoJSON();
        let placed = 0;
        let attempts = 0;
        
        while (placed < numZones && attempts < numZones * 5) {
            attempts++;
            const randomPt = turf.randomPoint(1, { bbox: bbox });
            if (turf.booleanPointInPolygon(randomPt.features[0], polygonFeature)) {
                const coords = randomPt.features[0].geometry.coordinates;
                const type = types[Math.floor(Math.random() * types.length)];
                const icon = L.divIcon({
                    className: 'resource-icon',
                    html: type.icon,
                    iconSize: [56, 56],
                    iconAnchor: [28, 56]
                });
                L.marker([coords[1], coords[0]], { icon: icon }).addTo(resourceLayers);
                placed++;
            }
        }
    }

    function toggleMenu() {
        const menu = document.getElementById('side-menu');
        const btn = document.getElementById('toggle-btn');
        menu.classList.toggle('active');
        btn.innerHTML = menu.classList.contains('active') ? "<" : ">";
        btn.style.left = menu.classList.contains('active') ? "320px" : "0";
    }

    function establishHQ() {
        if (hqLocked || !selectedLayer) return;
        
        hqLocked = true;
        clearInterval(window.gameTimer);
        document.getElementById('timer').style.color = "#2ecc71";
        document.getElementById('timer').innerText = "OK";
        
        document.getElementById('hq-name').innerText = "QG OPÃ‰RATIONNEL : " + countryDisplay.innerText;
        document.getElementById('action-zone').innerHTML = '<div style="color:var(--green); font-weight:bold; border:2px solid var(--green); padding:5px 15px; border-radius:4px;">ORDRES EN COURS</div>';
        
        const area = getArea(countryDisplay.innerText, selectedLayer);
        const budget = calculateBudget(area);
        const pop = Math.max(0.1, (area / 100000) * (0.5 + Math.random())); 
        currentPopulationMillions = pop;

        document.getElementById('money-val').innerText = budget.toLocaleString('fr-FR') + " $";
        document.getElementById('pop-total').innerText = "Pop: " + formatPopNumber(pop);

        const resources = ['fer', 'oil', 'stone', 'wood', 'wheat'];
        resources.forEach(res => {
            const val = calculateResource(area, 50, 900);
            document.getElementById(`val-${res}`).innerText = Math.floor(val) + " T";
            document.getElementById(`stock-${res}`).style.width = (val / 10) + "%"; 
        });

        generateResourceZones(selectedLayer, area);
        
        map.fitBounds(selectedLayer.getBounds(), { padding: [50, 50], maxZoom: 5 });
        
        setTimeout(() => {
            if (!document.getElementById('side-menu').classList.contains('active')) {
                toggleMenu();
            }
            updateMainRatio(30); 
        }, 800);
    }

    function onCountryClick(e) {
        if (hqLocked) return;
        
        if (selectedLayer) {
            geojsonLayer.resetStyle(selectedLayer);
        }
        
        selectedLayer = e.target;
        selectedLayer.setStyle({
            weight: 3,
            color: '#00d4ff',
            fillOpacity: isLightMode ? 0.6 : 0.4,
            dashArray: ''
        });
        
        selectedLayer.bringToFront();
        map.fitBounds(e.target.getBounds(), { padding: [20, 20], maxZoom: 4 });

        const props = e.target.feature.properties;
        const name = props.name || "Territoire Inconnu";
        const iso = props.iso_a2 || "-99";

        countryDisplay.innerText = name;
        flagDisplay.innerText = getFlagEmoji(iso, name);
        
        const actionZone = document.getElementById('action-zone');
        actionZone.innerHTML = `<button id="btn-hq" onclick="establishHQ()">Ã‰TABLIR QG ICI</button>`;
    }

    function onEachFeature(feature, layer) {
        layer.on({
            click: onCountryClick,
            mouseover: function(e) {
                if(hqLocked) return;
                const layer = e.target;
                layer.setStyle({ fillOpacity: isLightMode ? 0.7 : 0.6 });
            },
            mouseout: function(e) {
                if(hqLocked) return;
                const layer = e.target;
                if (layer !== selectedLayer) {
                    geojsonLayer.resetStyle(layer);
                } else {
                    layer.setStyle({ fillOpacity: isLightMode ? 0.6 : 0.4 });
                }
            }
        });
    }

    let geojsonLayer;
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(response => response.json())
        .then(data => {
            data.features = data.features.filter(f => f.id !== "ATA");
            
            geojsonLayer = L.geoJson(data, {
                style: getCountryStyle, // Utilisation de la fonction dynamique
                onEachFeature: onEachFeature
            }).addTo(map);

            document.getElementById('toggle-btn').style.display = 'block';
        })
        .catch(err => {
            console.error("Erreur chargement carte:", err);
            countryDisplay.innerText = "ERREUR CHARGEMENT CARTE";
        });

</script>
</body>
</html>
