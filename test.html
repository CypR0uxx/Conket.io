<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OpenFront 1918 - Drapeaux Mondiaux</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --blue: #00d4ff; --red: #ff3131; --gold: #ffd700; --green: #2ecc71;
            --bg: #111; --header-bg: #000; --text: #fff; --panel: #1a1a1a; --border: #333;
            --iron: #bdc3c7; --stone: #7f8c8d; --oil: #2c3e50; --wood: #27ae60; --wheat: #f1c40f;
        }
        
        * {
            cursor: crosshair !important;
        }

        body { margin: 0; padding: 0; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        #info-header {
            width: 100%; height: 120px;
            background: var(--header-bg); color: var(--text);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--blue); box-sizing: border-box; padding: 0 30px; z-index: 1001;
        }

        .flag-frame { 
            width: 110px; height: 80px; 
            border: 2px solid var(--blue); 
            background: #222; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
            font-size: 3.5em;
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        #flag-emoji { 
            line-height: 1;
            display: block;
        }

        #main-view { display: flex; flex-grow: 1; width: 100%; position: relative; overflow: hidden; }
        
        #side-menu { 
            width: 0; background: var(--panel); overflow-y: auto; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            color: var(--text); display: flex; flex-direction: column; z-index: 1000;
        }
        #side-menu.active { width: 320px; border-right: 2px solid var(--blue); }
        
        .menu-content { width: 300px; padding: 20px; box-sizing: border-box; opacity: 0; transition: 0.3s; }
        #side-menu.active .menu-content { opacity: 1; }

        .money-box { background: #000; padding: 10px; border: 1px dashed var(--gold); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* Styles pour les anciennes barres de ressources (Statistiques) */
        .res-item { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; font-size: 0.85em; border-left: 3px solid var(--blue); padding-left: 10px; }
        .res-bar { flex-grow: 1; height: 6px; background: #333; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .res-fill { height: 100%; background: var(--blue); }

        .pop-section { margin-top: 30px; padding: 15px; background: #000; border: 1px solid var(--border); border-radius: 8px; }
        .ratio-container { width: 100%; height: 25px; display: flex; margin: 10px 0; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .ratio-workers { background: var(--blue); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #000; }
        .ratio-soldiers { background: var(--red); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #fff; }
        
        /* Styles pour les jauges interactives */
        .worker-dist-section { margin-top: 20px; border-top: 1px dashed #444; padding-top: 15px; }
        .sub-gauge-row { margin-bottom: 12px; } /* Espacement augment√© pour les curseurs */
        .sub-gauge-label { font-size: 0.75em; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .sub-gauge-track { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .sub-gauge-fill { height: 100%; transition: width 0.2s ease-out; }
        
        /* Style des curseurs de priorit√© */
        .prio-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #333;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }
        .prio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
            border: 2px solid #000;
        }

        #toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: var(--blue); border: none; width: 25px; height: 50px; display: none; z-index: 2000; font-weight: bold; cursor: pointer; border-radius: 0 5px 5px 0; }

        #map { flex-grow: 1; background: #0b0b0b !important; }
        #game-over { position: fixed; inset: 0; background: rgba(20, 0, 0, 0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; }
        
        .btn-restart { margin-top: 20px; padding: 12px 24px; background: var(--red); border: none; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="game-over">
    <h1 style="font-size: 3em; margin-bottom: 10px;">MISSION INTERROMPUE</h1>
    <p>Le temps imparti pour le d√©ploiement a expir√©.</p>
    <button class="btn-restart" onclick="location.reload()">R√âESSAYER</button>
</div>

<header id="info-header">
    <div id="timer" style="font-size: 2.5em; color: var(--red); font-weight: bold; width: 60px;">15</div>
    <div style="display: flex; align-items: center; flex-grow: 1; margin-left: 30px;">
        <div class="flag-frame"><span id="flag-emoji">üåê</span></div>
        <div id="country-name" style="font-size: 1.8em; margin-left: 20px; font-weight: bold; letter-spacing: 1px;">INITIALISATION...</div>
    </div>
    <div id="action-zone"></div>
</header>

<div id="main-view">
    <div id="side-menu">
        <div class="menu-content">
            <h3 style="color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px; margin-bottom: 15px;">GESTION DU TERRITOIRE</h3>
            <div id="hq-name" style="color: var(--gold); margin-bottom: 20px; font-weight: bold;">---</div>

            <div class="money-box">
                <span style="font-size: 1.5em;">üí∞</span>
                <div style="text-align: left;">
                    <div style="font-size: 0.7em; color: var(--gold); font-weight: bold;">BUDGET NATIONAL</div>
                    <div id="money-val" style="font-size: 1.3em; font-family: monospace;">1,240,500 $</div>
                </div>
            </div>

            <!-- Statistiques Stocks -->
            <div class="res-item"><span>Stock Fer</span><div class="res-bar"><div class="res-fill" style="width: 70%;"></div></div></div>
            <div class="res-item"><span>Stock Bl√©</span><div class="res-bar"><div class="res-fill" style="width: 80%;"></div></div></div>

            <div class="pop-section">
                <div style="font-size: 0.8em; color: var(--blue); margin-bottom: 10px; font-weight: bold;">POPULATION TOTALE</div>
                <div class="ratio-container">
                    <div id="workers-bar" class="ratio-workers" style="width: 70%;">TRAVAIL</div>
                    <div id="soldiers-bar" class="ratio-soldiers" style="width: 30%;">ARM√âE</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7em; margin-top: 8px;">
                    <span id="pop-total">Pop: ---</span>
                    <span id="mobilization-text" style="color: var(--red); font-weight: bold;">Mobilisation: 30%</span>
                </div>
                <input type="range" min="0" max="100" value="30" style="width:100%; margin-top:15px;" oninput="updateMainRatio(this.value)">

                <!-- SECTION : Jauges de r√©partition des travailleurs INTERACTIVES -->
                <div class="worker-dist-section">
                    <div style="font-size: 0.75em; color: #fff; margin-bottom: 12px; font-weight: bold; border-left: 3px solid var(--gold); padding-left: 8px;">
                        AFFECTATION DES TRAVAILLEURS
                    </div>

                    <!-- Fer -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>‚õèÔ∏è Fer</span><span id="txt-fer" style="color:var(--iron)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-fer" class="sub-gauge-fill" style="background: var(--iron); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- P√©trole -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>üõ¢Ô∏è P√©trole</span><span id="txt-oil" style="color: #4a69bd">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-oil" class="sub-gauge-fill" style="background: var(--oil); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="10" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- Pierre -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>üß± Pierre</span><span id="txt-stone" style="color:var(--stone)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-stone" class="sub-gauge-fill" style="background: var(--stone); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- For√™t -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>üå≤ For√™t</span><span id="txt-wood" style="color:var(--wood)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wood" class="sub-gauge-fill" style="background: var(--wood); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- Bl√© -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>üåæ Bl√©</span><span id="txt-wheat" style="color:var(--wheat)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wheat" class="sub-gauge-fill" style="background: var(--wheat); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="30" oninput="updateWorkerDistribution()">
                    </div>
                    
                    <div style="font-size: 0.65em; color: #666; margin-top: 5px; text-align: right;">Total Travailleurs: 100%</div>
                </div>
            </div>
        </div>
    </div>
    <button id="toggle-btn" onclick="toggleMenu()">></button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { 
        attributionControl: false, 
        zoomControl: false, 
        minZoom: 2,
        maxBounds: [[-90, -180], [90, 180]]
    }).setView([20, 0], 2);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { 
        noWrap: true 
    }).addTo(map);

    let hqLocked = false, selectedLayer = null, timeLeft = 15;
    const flagDisplay = document.getElementById('flag-emoji');
    const countryDisplay = document.getElementById('country-name');
    let currentWorkerPct = 70; // Valeur par d√©faut
    let currentPopulationMillions = 42.5; // Population dynamique

    // Dictionnaire manuel des drapeaux
    const flagMap = {
        "Afghanistan": "üá¶üá´", "Albania": "üá¶üá±", "Algeria": "üá©üáø", "Andorra": "üá¶üá©", "Angola": "üá¶üá¥",
        "Antigua and Barbuda": "üá¶üá¨", "Argentina": "üá¶üá∑", "Armenia": "üá¶üá≤", "Australia": "üá¶üá∫", "Austria": "üá¶üáπ",
        "Azerbaijan": "üá¶üáø", "Bahamas": "üáßüá∏", "Bahrain": "üáßüá≠", "Bangladesh": "üáßüá©", "Barbados": "üáßüáß",
        "Belarus": "üáßüáæ", "Belgium": "üáßüá™", "Belize": "üáßüáø", "Benin": "üáßüáØ", "Bhutan": "üáßüáπ",
        "Bolivia": "üáßüá¥", "Bosnia and Herzegovina": "üáßüá¶", "Botswana": "üáßüáº", "Brazil": "üáßüá∑", "Brunei": "üáßüá≥",
        "Bulgaria": "üáßüá¨", "Burkina Faso": "üáßüá´", "Burundi": "üáßüáÆ", "Cabo Verde": "üá®üáª", "Cambodia": "üá∞üá≠",
        "Cameroon": "üá®üá≤", "Canada": "üá®üá¶", "Central African Republic": "üá®üá´", "Chad": "üáπüá©", "Chile": "üá®üá±",
        "China": "üá®üá≥", "Colombia": "üá®üá¥", "Comoros": "üá∞üá≤", "Congo (Democratic Republic of the)": "üá®üá©", "Congo (Republic of the)": "üá®üá¨",
        "Costa Rica": "üá®üá∑", "Croatia": "üá≠üá∑", "Cuba": "üá®üá∫", "Cyprus": "üá®üáæ", "Czech Republic": "üá®üáø",
        "Denmark": "üá©üá∞", "Djibouti": "üá©·¥ä", "Dominica": "üá©üá≤", "Dominican Republic": "üá©üá¥", "East Timor": "üáπüá±",
        "Ecuador": "üá™üá®", "Egypt": "üá™üá¨", "El Salvador": "üá∏üáª", "Equatorial Guinea": "üá¨üá∂", "Eritrea": "üá™üá∑",
        "Estonia": "üá™üá™", "Eswatini": "üá∏üáø", "Ethiopia": "üá™üáπ", "Fiji": "üá´üáØ", "Finland": "üá´üáÆ",
        "France": "üá´üá∑", "Gabon": "üá¨üá¶", "Gambia": "üá¨üá≤", "Georgia": "üá¨üá™", "Germany": "üá©üá™",
        "Ghana": "üá¨üá≠", "Greece": "üá¨üá∑", "Grenada": "üá¨üá©", "Guatemala": "üá¨üáπ", "Guinea": "üá¨üá≥",
        "Guinea-Bissau": "üá¨üáº", "Guyana": "üá¨üáæ", "Haiti": "üá≠üáπ", "Honduras": "üá≠üá≥", "Hungary": "üá≠üá∫",
        "Iceland": "üáÆüá∏", "India": "üáÆüá≥", "Indonesia": "üáÆüá©", "Iran": "üáÆüá∑", "Iraq": "üáÆüá∂",
        "Ireland": "üáÆüá™", "Israel": "üáÆüá±", "Italy": "üáÆüáπ", "Ivory Coast": "üá®üáÆ", "Jamaica": "üáØüá≤",
        "Japan": "üáØüáµ", "Jordan": "üáØüá¥", "Kazakhstan": "üá∞üáø", "Kenya": "üá∞üá™", "Kiribati": "üá∞üáÆ",
        "Kuwait": "üá∞üáº", "Kyrgyzstan": "üá∞üá¨", "Laos": "üá±üá¶", "Latvia": "üá±üáª", "Lebanon": "üá±üáß",
        "Lesotho": "üá±üá∏", "Liberia": "üá±üá∑", "Libya": "üá±üáæ", "Liechtenstein": "üá±üáÆ", "Lithuania": "üá±üáπ",
        "Luxembourg": "üá±üá∫", "Madagascar": "üá≤üá¨", "Malawi": "üá≤üáº", "Malaysia": "üá≤üáæ", "Maldives": "üá≤üáª",
        "Mali": "üá≤üá±", "Malta": "üá≤üáπ", "Marshall Islands": "üá≤üá≠", "Mauritania": "üá≤üá∑", "Mauritius": "üá≤üá∫",
        "Mexico": "üá≤üáΩ", "Micronesia": "üá´üá≤", "Moldova": "üá≤üá©", "Monaco": "üá≤üá®", "Mongolia": "üá≤üá≥",
        "Montenegro": "üá≤üá™", "Morocco": "üá≤üá¶", "Mozambique": "üá≤üáø", "Myanmar": "üá≤üá≤", "Namibia": "üá≥üá¶",
        "Nauru": "üá≥üá∑", "Nepal": "üá≥üáµ", "Netherlands": "üá≥üá±", "New Zealand": "üá≥üáø", "Nicaragua": "üá≥üáÆ",
        "Niger": "üá≥üá™", "Nigeria": "üá≥üá¨", "North Korea": "üá∞üáµ", "North Macedonia": "üá≤üá∞", "Norway": "üá≥üá¥",
        "Oman": "üá¥üá≤", "Pakistan": "üáµüá∞", "Palau": "üáµüáº", "Palestine": "üáµüá∏", "Panama": "üáµüá¶",
        "Papua New Guinea": "üáµüá¨", "Paraguay": "üáµüáæ", "Peru": "üáµüá™", "Philippines": "üáµüá≠", "Poland": "üáµüá±",
        "Portugal": "üáµüáπ", "Qatar": "üá∂üá¶", "Romania": "üá∑üá¥", "Russia": "üá∑üá∫", "Rwanda": "üá∑üáº",
        "Saint Kitts and Nevis": "üá∞üá≥", "Saint Lucia": "üá±üá®", "Saint Vincent and the Grenadines": "üáªüá®", "Samoa": "üáºüá∏", "San Marino": "üá∏üá≤",
        "Sao Tome and Principe": "üá∏üáπ", "Saudi Arabia": "üá∏üá¶", "Senegal": "üá∏üá≥", "Serbia": "üá∑üá∏", "Seychelles": "üá∏üá®",
        "Sierra Leone": "üá∏üá±", "Singapore": "üá∏üá¨", "Slovakia": "üá∏üá∞", "Slovenia": "üá∏üáÆ", "Solomon Islands": "üá∏üáß",
        "Somalia": "üá∏üá¥", "South Africa": "üáøüá¶", "South Korea": "üá∞üá∑", "South Sudan": "üá∏üá∏", "Spain": "üá™üá∏",
        "Sri Lanka": "üá±üá∞", "Sudan": "üá∏üá©", "Suriname": "üá∏üá∑", "Sweden": "üá∏üá™", "Switzerland": "üá®üá≠",
        "Syria": "üá∏üáæ", "Taiwan": "üáπüáº", "Tajikistan": "üáπüáØ", "Tanzania": "üáπüáø", "Thailand": "üáπüá≠",
        "Togo": "üáπüá¨", "Tonga": "üáπüá¥", "Trinidad and Tobago": "üáπüáπ", "Tunisia": "üáπüá≥", "Turkey": "üáπüá∑",
        "Turkmenistan": "üáπüá≤", "Tuvalu": "üáπüáª", "Uganda": "üá∫üá¨", "Ukraine": "üá∫üá¶", "United Arab Emirates": "üá¶üá™",
        "United Kingdom": "üá¨üáß", "United States of America": "üá∫üá∏", "Uruguay": "üá∫üáæ", "Uzbekistan": "üá∫üáø", "Vanuatu": "üáªüá∫",
        "Vatican City": "üáªüá¶", "Venezuela": "üáªüá™", "Vietnam": "üáªüá≥", "Yemen": "üáæüá™", "Zambia": "üáøüá≤",
        "Zimbabwe": "üáøüáº", "baykonur cosmodrome": "üá∞üáø", "Somaliland": "üá∏üá¥", "democratic republic of the congo": "üá®üá©"
    };

    // Mise √† jour de la barre principale (Arm√©e vs Travailleurs)
    window.updateMainRatio = function(val) {
        const soldierPct = parseInt(val);
        currentWorkerPct = 100 - soldierPct;

        document.getElementById('soldiers-bar').style.width = soldierPct + "%";
        document.getElementById('workers-bar').style.width = currentWorkerPct + "%";
        document.getElementById('mobilization-text').innerText = "Mobilisation: " + soldierPct + "%";

        // Recalculer la distribution des travailleurs car la population de travailleurs a chang√©
        window.updateWorkerDistribution();
    };

    // Nouvelle fonction pour g√©rer la r√©partition dynamique
    window.updateWorkerDistribution = function() {
        const sliders = document.querySelectorAll('.prio-slider');
        const weights = Array.from(sliders).map(s => parseInt(s.value));
        const totalWeight = weights.reduce((a, b) => a + b, 0) || 1; 

        // Calcul de la main d'≈ìuvre DISPONIBLE
        const totalWorkersAvailable = currentPopulationMillions * (currentWorkerPct / 100);

        const resourceIds = ['fer', 'oil', 'stone', 'wood', 'wheat'];

        weights.forEach((weight, index) => {
            const id = resourceIds[index];
            const relativePct = (weight / totalWeight); 
            const displayPct = Math.round(relativePct * 100);
            
            const workersForResource = totalWorkersAvailable * relativePct;
            const workersFormatted = workersForResource.toFixed(1) + "M";

            const visualWidth = relativePct * 100;
            document.getElementById(`gauge-${id}`).style.width = visualWidth + "%";
            document.getElementById(`txt-${id}`).innerText = `${displayPct}% (${workersFormatted})`;
        });
    };

    // Initialisation
    window.updateMainRatio(30);

    const countdown = setInterval(() => {
        if (hqLocked) return;
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) { 
            clearInterval(countdown); 
            document.getElementById('game-over').style.display = 'flex'; 
        }
    }, 1000);

    function getFlagEmoji(isoCode, countryName) {
        if (flagMap[countryName]) return flagMap[countryName];
        if (isoCode && isoCode !== "-99" && isoCode.length === 2) {
            const code = isoCode.toUpperCase();
            return String.fromCodePoint(...[...code].map(c => c.charCodeAt(0) + 127397));
        }
        return "üåê"; 
    }

    // Fonction de calcul de population CORRIG√âE V2
    function calculatePopulation(layer) {
        const bounds = layer.getBounds();
        // Calcul simple largeur/hauteur en degr√©s
        let width = Math.abs(bounds.getEast() - bounds.getWest());
        const height = Math.abs(bounds.getNorth() - bounds.getSouth());
        const center = bounds.getCenter();

        // 1. Correction Russie et pays "qui d√©passent" (Largeur monde)
        // La Russie traverse souvent la date (-180/180), donc sa largeur brute peut para√Ætre petite ou √©norme selon le GeoJSON
        // Ici on assume une largeur brute. Si c'est > 180, c'est probablement un empire/monde.
        // On ne la cape plus artificiellement √† 60, on laisse la "vraie" taille s'exprimer (360 max).
        // Cela va rendre la Russie "tr√®s grande" -> donc "tr√®s peu peupl√©e" selon la r√®gle invers√©e.
        
        // 2. Score de surface approximatif (Degr√©s carr√©s)
        let areaScore = width * height;

        // 3. Correction Latitude (P√©nalit√© Grand Nord)
        // Les pays au nord (Groenland, Russie, Canada) sont visuellement √©tir√©s par Mercator.
        // On augmente leur score pour r√©duire encore leur population.
        // Groenland (~75N) vs Russie (~60N). Groenland prendra un plus gros malus visuel.
        if (Math.abs(center.lat) > 50) {
            // Facteur augmentant avec la latitude
            const latFactor = 1 + (Math.abs(center.lat) - 50) / 20; 
            areaScore = areaScore * latFactor; 
        }

        // 4. Formule Exponentielle ajust√©e (Moins raide)
        // Petit pays (Area ~1-10) -> Tend vers maxPop
        // Moyen pays (Area ~100) -> Milieu
        // G√©ant (Area ~2000+) -> Tend vers minPop
        
        const minPop = 2;   // Minimum 2M (Russie, Canada, Australie...)
        const maxPop = 60;  // Maximum 60M (Petits pays denses : Belgique, Suisse...)
        
        // Coefficient de d√©croissance k
        // Si Area = 6000 (Russie), on veut √™tre proche de minPop.
        // Si Area = 500 (France), on veut √™tre moyen (ex: 30-40M).
        // Si Area = 5 (Belgique), on veut √™tre proche de maxPop (60M).
        
        // Formule : Pop = Min + (Max - Min) * e^(-k * Area)
        // On choisit k = 0.0004 pour adoucir la pente.
        let pop = minPop + (maxPop - minPop) * Math.exp(-0.0004 * areaScore);
        
        return pop.toFixed(1);
    }

    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(r => r.json())
    .then(data => {
        L.geoJson(data, {
            style: { fillColor: '#222', fillOpacity: 0.7, color: '#444', weight: 1 },
            onEachFeature: (feature, layer) => {
                
                layer.on('mouseover', function() {
                    if(hqLocked) return;
                    this.setStyle({ fillOpacity: 0.9, fillColor: '#444', color: '#00d4ff' });
                    
                    const props = feature.properties;
                    const name = props.ADMIN || props.name || "Inconnu";
                    const iso = props.ISO_A2 || props.iso_a2 || "";
                    
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji(iso.trim(), name);
                });

                layer.on('mouseout', function() {
                    if (this !== selectedLayer) {
                        this.setStyle({ fillOpacity: 0.7, fillColor: '#222', color: '#444' });
                    }
                    if(hqLocked) return;

                    if (selectedLayer) {
                        const p = selectedLayer.feature.properties;
                        const name = p.ADMIN || p.name;
                        countryDisplay.innerText = name.toUpperCase();
                        flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);
                    } else {
                        countryDisplay.innerText = "S√âLECTIONNEZ UNE ZONE";
                        flagDisplay.innerText = "üåê";
                    }
                });

                layer.on('click', function() {
                    if(hqLocked) return;
                    if(selectedLayer) selectedLayer.setStyle({ fillColor: '#222', weight: 1, color: '#444' });
                    selectedLayer = this;
                    this.setStyle({ fillColor: '#333', weight: 2, color: '#00d4ff' });
                    
                    const p = feature.properties;
                    const name = p.ADMIN || p.name;
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);

                    // --- Calcul de la population ---
                    const pop = calculatePopulation(layer);
                    currentPopulationMillions = parseFloat(pop);
                    
                    // Mise √† jour de l'affichage
                    document.getElementById('pop-total').innerText = "Pop: " + pop + "M";
                    window.updateWorkerDistribution(); 

                    document.getElementById('action-zone').innerHTML = `
                        <button onclick="lockHQ()" style="background:var(--blue); border:none; padding:10px 20px; font-weight:bold; color:black; cursor:pointer; border-radius:4px;">
                            √âTABLIR QG
                        </button>`;
                });
            }
        }).addTo(map);
    });

    window.lockHQ = function() {
        if (!selectedLayer) return;
        hqLocked = true;
        selectedLayer.setStyle({ fillColor: '#00d4ff', color: '#ffd700', weight: 3, fillOpacity: 0.8 });
        document.getElementById('side-menu').classList.add('active');
        document.getElementById('toggle-btn').style.display = 'block';
        document.getElementById('toggle-btn').style.left = "320px";
        document.getElementById('hq-name').innerText = "QG ACTIV√â : " + countryDisplay.innerText;
        document.getElementById('action-zone').innerHTML = `<span style="color:var(--green); font-weight:bold;">PROFIL ACTIV√â</span>`;
        map.fitBounds(selectedLayer.getBounds(), { padding: [50, 50] });
    };

    window.toggleMenu = function() {
        const menu = document.getElementById('side-menu');
        const btn = document.getElementById('toggle-btn');
        const isOpen = menu.classList.toggle('active');
        btn.innerText = isOpen ? "<" : ">";
        btn.style.left = isOpen ? "320px" : "0";
    };
</script>
</body>
</html>
