<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OpenFront 1918 - Drapeaux Mondiaux</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --blue: #00d4ff; --red: #ff3131; --gold: #ffd700; --green: #2ecc71;
            --bg: #111; --header-bg: #000; --text: #fff; --panel: #1a1a1a; --border: #333;
            --iron: #bdc3c7; --stone: #7f8c8d; --oil: #2c3e50; --wood: #27ae60; --wheat: #f1c40f;
        }
        
        * {
            cursor: crosshair !important;
        }

        body { margin: 0; padding: 0; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        #info-header {
            width: 100%; height: 120px;
            background: var(--header-bg); color: var(--text);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--blue); box-sizing: border-box; padding: 0 30px; z-index: 1001;
        }

        .flag-frame { 
            width: 110px; height: 80px; 
            border: 2px solid var(--blue); 
            background: #222; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
            font-size: 3.5em;
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        #flag-emoji { 
            line-height: 1;
            display: block;
        }

        #main-view { display: flex; flex-grow: 1; width: 100%; position: relative; overflow: hidden; }
        
        #side-menu { 
            width: 0; background: var(--panel); overflow-y: auto; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            color: var(--text); display: flex; flex-direction: column; z-index: 1000;
        }
        #side-menu.active { width: 320px; border-right: 2px solid var(--blue); }
        
        .menu-content { width: 300px; padding: 20px; box-sizing: border-box; opacity: 0; transition: 0.3s; }
        #side-menu.active .menu-content { opacity: 1; }

        .money-box { background: #000; padding: 10px; border: 1px dashed var(--gold); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* Styles pour les anciennes barres de ressources (Statistiques) */
        .res-item { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; font-size: 0.85em; border-left: 3px solid var(--blue); padding-left: 10px; }
        .res-bar { flex-grow: 1; height: 6px; background: #333; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .res-fill { height: 100%; background: var(--blue); }

        .pop-section { margin-top: 30px; padding: 15px; background: #000; border: 1px solid var(--border); border-radius: 8px; }
        .ratio-container { width: 100%; height: 25px; display: flex; margin: 10px 0; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .ratio-workers { background: var(--blue); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #000; }
        .ratio-soldiers { background: var(--red); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #fff; }
        
        /* Styles pour les jauges interactives */
        .worker-dist-section { margin-top: 20px; border-top: 1px dashed #444; padding-top: 15px; }
        .sub-gauge-row { margin-bottom: 12px; } /* Espacement augmentÃ© pour les curseurs */
        .sub-gauge-label { font-size: 0.75em; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .sub-gauge-track { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .sub-gauge-fill { height: 100%; transition: width 0.2s ease-out; }
        
        /* Style des curseurs de prioritÃ© */
        .prio-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #333;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }
        .prio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
            border: 2px solid #000;
        }

        #toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: var(--blue); border: none; width: 25px; height: 50px; display: none; z-index: 2000; font-weight: bold; cursor: pointer; border-radius: 0 5px 5px 0; }

        #map { flex-grow: 1; background: #0b0b0b !important; }
        #game-over { position: fixed; inset: 0; background: rgba(20, 0, 0, 0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; }
        
        .btn-restart { margin-top: 20px; padding: 12px 24px; background: var(--red); border: none; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="game-over">
    <h1 style="font-size: 3em; margin-bottom: 10px;">MISSION INTERROMPUE</h1>
    <p>Le temps imparti pour le dÃ©ploiement a expirÃ©.</p>
    <button class="btn-restart" onclick="location.reload()">RÃ‰ESSAYER</button>
</div>

<header id="info-header">
    <div id="timer" style="font-size: 2.5em; color: var(--red); font-weight: bold; width: 60px;">15</div>
    <div style="display: flex; align-items: center; flex-grow: 1; margin-left: 30px;">
        <div class="flag-frame"><span id="flag-emoji">ğŸŒ</span></div>
        <div id="country-name" style="font-size: 1.8em; margin-left: 20px; font-weight: bold; letter-spacing: 1px;">INITIALISATION...</div>
    </div>
    <div id="action-zone"></div>
</header>

<div id="main-view">
    <div id="side-menu">
        <div class="menu-content">
            <h3 style="color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px; margin-bottom: 15px;">GESTION DU TERRITOIRE</h3>
            <div id="hq-name" style="color: var(--gold); margin-bottom: 20px; font-weight: bold;">---</div>

            <div class="money-box">
                <span style="font-size: 1.5em;">ğŸ’°</span>
                <div style="text-align: left;">
                    <div style="font-size: 0.7em; color: var(--gold); font-weight: bold;">BUDGET NATIONAL</div>
                    <div id="money-val" style="font-size: 1.3em; font-family: monospace;">1,240,500 $</div>
                </div>
            </div>

            <!-- Statistiques Stocks -->
            <div class="res-item"><span>Stock Fer</span><div class="res-bar"><div class="res-fill" style="width: 70%;"></div></div></div>
            <div class="res-item"><span>Stock BlÃ©</span><div class="res-bar"><div class="res-fill" style="width: 80%;"></div></div></div>

            <div class="pop-section">
                <div style="font-size: 0.8em; color: var(--blue); margin-bottom: 10px; font-weight: bold;">POPULATION TOTALE</div>
                <div class="ratio-container">
                    <div id="workers-bar" class="ratio-workers" style="width: 70%;">TRAVAIL</div>
                    <div id="soldiers-bar" class="ratio-soldiers" style="width: 30%;">ARMÃ‰E</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7em; margin-top: 8px;">
                    <span id="pop-total">Pop: ---</span>
                    <span id="mobilization-text" style="color: var(--red); font-weight: bold;">Mobilisation: 30%</span>
                </div>
                <input type="range" min="0" max="100" value="30" style="width:100%; margin-top:15px;" oninput="updateMainRatio(this.value)">

                <!-- SECTION : Jauges de rÃ©partition des travailleurs INTERACTIVES -->
                <div class="worker-dist-section">
                    <div style="font-size: 0.75em; color: #fff; margin-bottom: 12px; font-weight: bold; border-left: 3px solid var(--gold); padding-left: 8px;">
                        AFFECTATION DES TRAVAILLEURS
                    </div>

                    <!-- Fer -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>â›ï¸ Fer</span><span id="txt-fer" style="color:var(--iron)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-fer" class="sub-gauge-fill" style="background: var(--iron); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- PÃ©trole -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸ›¢ï¸ PÃ©trole</span><span id="txt-oil" style="color: #4a69bd">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-oil" class="sub-gauge-fill" style="background: var(--oil); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="10" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- Pierre -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸ§± Pierre</span><span id="txt-stone" style="color:var(--stone)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-stone" class="sub-gauge-fill" style="background: var(--stone); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- ForÃªt -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸŒ² ForÃªt</span><span id="txt-wood" style="color:var(--wood)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wood" class="sub-gauge-fill" style="background: var(--wood); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- BlÃ© -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸŒ¾ BlÃ©</span><span id="txt-wheat" style="color:var(--wheat)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wheat" class="sub-gauge-fill" style="background: var(--wheat); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="30" oninput="updateWorkerDistribution()">
                    </div>
                    
                    <div style="font-size: 0.65em; color: #666; margin-top: 5px; text-align: right;">Total Travailleurs: 100%</div>
                </div>
            </div>
        </div>
    </div>
    <button id="toggle-btn" onclick="toggleMenu()">></button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { 
        attributionControl: false, 
        zoomControl: false, 
        minZoom: 2,
        maxBounds: [[-90, -180], [90, 180]]
    }).setView([20, 0], 2);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { 
        noWrap: true 
    }).addTo(map);

    let hqLocked = false, selectedLayer = null, timeLeft = 15;
    const flagDisplay = document.getElementById('flag-emoji');
    const countryDisplay = document.getElementById('country-name');
    let currentWorkerPct = 70; // Valeur par dÃ©faut
    let currentPopulationMillions = 42.5; // Population dynamique

    // Dictionnaire manuel des drapeaux
    const flagMap = {
        "Afghanistan": "ğŸ‡¦ğŸ‡«", "Albania": "ğŸ‡¦ğŸ‡±", "Algeria": "ğŸ‡©ğŸ‡¿", "Andorra": "ğŸ‡¦ğŸ‡©", "Angola": "ğŸ‡¦ğŸ‡´",
        "Antigua and Barbuda": "ğŸ‡¦ğŸ‡¬", "Argentina": "ğŸ‡¦ğŸ‡·", "Armenia": "ğŸ‡¦ğŸ‡²", "Australia": "ğŸ‡¦ğŸ‡º", "Austria": "ğŸ‡¦ğŸ‡¹",
        "Azerbaijan": "ğŸ‡¦ğŸ‡¿", "Bahamas": "ğŸ‡§ğŸ‡¸", "Bahrain": "ğŸ‡§ğŸ‡­", "Bangladesh": "ğŸ‡§ğŸ‡©", "Barbados": "ğŸ‡§ğŸ‡§",
        "Belarus": "ğŸ‡§ğŸ‡¾", "Belgium": "ğŸ‡§ğŸ‡ª", "Belize": "ğŸ‡§ğŸ‡¿", "Benin": "ğŸ‡§ğŸ‡¯", "Bhutan": "ğŸ‡§ğŸ‡¹",
        "Bolivia": "ğŸ‡§ğŸ‡´", "Bosnia and Herzegovina": "ğŸ‡§ğŸ‡¦", "Botswana": "ğŸ‡§ğŸ‡¼", "Brazil": "ğŸ‡§ğŸ‡·", "Brunei": "ğŸ‡§ğŸ‡³",
        "Bulgaria": "ğŸ‡§ğŸ‡¬", "Burkina Faso": "ğŸ‡§ğŸ‡«", "Burundi": "ğŸ‡§ğŸ‡®", "Cabo Verde": "ğŸ‡¨ğŸ‡»", "Cambodia": "ğŸ‡°ğŸ‡­",
        "Cameroon": "ğŸ‡¨ğŸ‡²", "Canada": "ğŸ‡¨ğŸ‡¦", "Central African Republic": "ğŸ‡¨ğŸ‡«", "Chad": "ğŸ‡¹ğŸ‡©", "Chile": "ğŸ‡¨ğŸ‡±",
        "China": "ğŸ‡¨ğŸ‡³", "Colombia": "ğŸ‡¨ğŸ‡´", "Comoros": "ğŸ‡°ğŸ‡²", "Congo (Democratic Republic of the)": "ğŸ‡¨ğŸ‡©", "Congo (Republic of the)": "ğŸ‡¨ğŸ‡¬",
        "Costa Rica": "ğŸ‡¨ğŸ‡·", "Croatia": "ğŸ‡­ğŸ‡·", "Cuba": "ğŸ‡¨ğŸ‡º", "Cyprus": "ğŸ‡¨ğŸ‡¾", "Czech Republic": "ğŸ‡¨ğŸ‡¿",
        "Denmark": "ğŸ‡©ğŸ‡°", "Djibouti": "ğŸ‡©á´Š", "Dominica": "ğŸ‡©ğŸ‡²", "Dominican Republic": "ğŸ‡©ğŸ‡´", "East Timor": "ğŸ‡¹ğŸ‡±",
        "Ecuador": "ğŸ‡ªğŸ‡¨", "Egypt": "ğŸ‡ªğŸ‡¬", "El Salvador": "ğŸ‡¸ğŸ‡»", "Equatorial Guinea": "ğŸ‡¬ğŸ‡¶", "Eritrea": "ğŸ‡ªğŸ‡·",
        "Estonia": "ğŸ‡ªğŸ‡ª", "Eswatini": "ğŸ‡¸ğŸ‡¿", "Ethiopia": "ğŸ‡ªğŸ‡¹", "Fiji": "ğŸ‡«ğŸ‡¯", "Finland": "ğŸ‡«ğŸ‡®",
        "France": "ğŸ‡«ğŸ‡·", "Gabon": "ğŸ‡¬ğŸ‡¦", "Gambia": "ğŸ‡¬ğŸ‡²", "Georgia": "ğŸ‡¬ğŸ‡ª", "Germany": "ğŸ‡©ğŸ‡ª",
        "Ghana": "ğŸ‡¬ğŸ‡­", "Greece": "ğŸ‡¬ğŸ‡·", "Grenada": "ğŸ‡¬ğŸ‡©", "Greenland": "ğŸ–• ğŸ‡ºğŸ‡¸","Guatemala": "ğŸ‡¬ğŸ‡¹", "Guinea": "ğŸ‡¬ğŸ‡³",
        "Guinea-Bissau": "ğŸ‡¬ğŸ‡¼", "Guyana": "ğŸ‡¬ğŸ‡¾", "Haiti": "ğŸ‡­ğŸ‡¹", "Honduras": "ğŸ‡­ğŸ‡³", "Hungary": "ğŸ‡­ğŸ‡º",
        "Iceland": "ğŸ‡®ğŸ‡¸", "India": "ğŸ‡®ğŸ‡³", "Indonesia": "ğŸ‡®ğŸ‡©", "Iran": "ğŸ‡®ğŸ‡·", "Iraq": "ğŸ‡®ğŸ‡¶",
        "Ireland": "ğŸ‡®ğŸ‡ª", "Israel": "ğŸ‡®ğŸ‡±", "Italy": "ğŸ‡®ğŸ‡¹", "Ivory Coast": "ğŸ‡¨ğŸ‡®", "Jamaica": "ğŸ‡¯ğŸ‡²",
        "Japan": "ğŸ‡¯ğŸ‡µ", "Jordan": "ğŸ‡¯ğŸ‡´", "Kazakhstan": "ğŸ‡°ğŸ‡¿", "Kenya": "ğŸ‡°ğŸ‡ª", "Kiribati": "ğŸ‡°ğŸ‡®",
        "Kuwait": "ğŸ‡°ğŸ‡¼", "Kyrgyzstan": "ğŸ‡°ğŸ‡¬", "Laos": "ğŸ‡±ğŸ‡¦", "Latvia": "ğŸ‡±ğŸ‡»", "Lebanon": "ğŸ‡±ğŸ‡§",
        "Lesotho": "ğŸ‡±ğŸ‡¸", "Liberia": "ğŸ‡±ğŸ‡·", "Libya": "ğŸ‡±ğŸ‡¾", "Liechtenstein": "ğŸ‡±ğŸ‡®", "Lithuania": "ğŸ‡±ğŸ‡¹",
        "Luxembourg": "ğŸ‡±ğŸ‡º", "Madagascar": "ğŸ‡²ğŸ‡¬", "Malawi": "ğŸ‡²ğŸ‡¼", "Malaysia": "ğŸ‡²ğŸ‡¾", "Maldives": "ğŸ‡²ğŸ‡»",
        "Mali": "ğŸ‡²ğŸ‡±", "Malta": "ğŸ‡²ğŸ‡¹", "Marshall Islands": "ğŸ‡²ğŸ‡­", "Mauritania": "ğŸ‡²ğŸ‡·", "Mauritius": "ğŸ‡²ğŸ‡º",
        "Mexico": "ğŸ‡²ğŸ‡½", "Micronesia": "ğŸ‡«ğŸ‡²", "Moldova": "ğŸ‡²ğŸ‡©", "Monaco": "ğŸ‡²ğŸ‡¨", "Mongolia": "ğŸ‡²ğŸ‡³",
        "Montenegro": "ğŸ‡²ğŸ‡ª", "Morocco": "ğŸ‡²ğŸ‡¦", "Mozambique": "ğŸ‡²ğŸ‡¿", "Myanmar": "ğŸ‡²ğŸ‡²", "Namibia": "ğŸ‡³ğŸ‡¦",
        "Nauru": "ğŸ‡³ğŸ‡·", "Nepal": "ğŸ‡³ğŸ‡µ", "Netherlands": "ğŸ‡³ğŸ‡±", "New Zealand": "ğŸ‡³ğŸ‡¿", "Nicaragua": "ğŸ‡³ğŸ‡®",
        "Niger": "ğŸ‡³ğŸ‡ª", "Nigeria": "ğŸ‡³ğŸ‡¬", "North Korea": "ğŸ‡°ğŸ‡µ", "North Macedonia": "ğŸ‡²ğŸ‡°", "Norway": "ğŸ‡³ğŸ‡´",
        "Oman": "ğŸ‡´ğŸ‡²", "Pakistan": "ğŸ‡µğŸ‡°", "Palau": "ğŸ‡µğŸ‡¼", "Palestine": "ğŸ‡µğŸ‡¸", "Panama": "ğŸ‡µğŸ‡¦",
        "Papua New Guinea": "ğŸ‡µğŸ‡¬", "Paraguay": "ğŸ‡µğŸ‡¾", "Peru": "ğŸ‡µğŸ‡ª", "Philippines": "ğŸ‡µğŸ‡­", "Poland": "ğŸ‡µğŸ‡±",
        "Portugal": "ğŸ‡µğŸ‡¹", "Qatar": "ğŸ‡¶ğŸ‡¦", "Romania": "ğŸ‡·ğŸ‡´", "Russia": "ğŸ‡·ğŸ‡º", "Rwanda": "ğŸ‡·ğŸ‡¼",
        "Saint Kitts and Nevis": "ğŸ‡°ğŸ‡³", "Saint Lucia": "ğŸ‡±ğŸ‡¨", "Saint Vincent and the Grenadines": "ğŸ‡»ğŸ‡¨", "Samoa": "ğŸ‡¼ğŸ‡¸", "San Marino": "ğŸ‡¸ğŸ‡²",
        "Sao Tome and Principe": "ğŸ‡¸ğŸ‡¹", "Saudi Arabia": "ğŸ‡¸ğŸ‡¦", "Senegal": "ğŸ‡¸ğŸ‡³", "Serbia": "ğŸ‡·ğŸ‡¸", "Seychelles": "ğŸ‡¸ğŸ‡¨",
        "Sierra Leone": "ğŸ‡¸ğŸ‡±", "Singapore": "ğŸ‡¸ğŸ‡¬", "Slovakia": "ğŸ‡¸ğŸ‡°", "Slovenia": "ğŸ‡¸ğŸ‡®", "Solomon Islands": "ğŸ‡¸ğŸ‡§",
        "Somalia": "ğŸ‡¸ğŸ‡´", "South Africa": "ğŸ‡¿ğŸ‡¦", "South Korea": "ğŸ‡°ğŸ‡·", "South Sudan": "ğŸ‡¸ğŸ‡¸", "Spain": "ğŸ‡ªğŸ‡¸",
        "Sri Lanka": "ğŸ‡±ğŸ‡°", "Sudan": "ğŸ‡¸ğŸ‡©", "Suriname": "ğŸ‡¸ğŸ‡·", "Sweden": "ğŸ‡¸ğŸ‡ª", "Switzerland": "ğŸ‡¨ğŸ‡­",
        "Syria": "ğŸ‡¸ğŸ‡¾", "Taiwan": "ğŸ‡¹ğŸ‡¼", "Tajikistan": "ğŸ‡¹ğŸ‡¯", "Tanzania": "ğŸ‡¹ğŸ‡¿", "Thailand": "ğŸ‡¹ğŸ‡­",
        "Togo": "ğŸ‡¹ğŸ‡¬", "Tonga": "ğŸ‡¹ğŸ‡´", "Trinidad and Tobago": "ğŸ‡¹ğŸ‡¹", "Tunisia": "ğŸ‡¹ğŸ‡³", "Turkey": "ğŸ‡¹ğŸ‡·",
        "Turkmenistan": "ğŸ‡¹ğŸ‡²", "Tuvalu": "ğŸ‡¹ğŸ‡»", "Uganda": "ğŸ‡ºğŸ‡¬", "Ukraine": "ğŸ‡ºğŸ‡¦", "United Arab Emirates": "ğŸ‡¦ğŸ‡ª",
        "United Kingdom": "ğŸ‡¬ğŸ‡§", "United States of America": "ğŸ‡ºğŸ‡¸", "Uruguay": "ğŸ‡ºğŸ‡¾", "Uzbekistan": "ğŸ‡ºğŸ‡¿", "Vanuatu": "ğŸ‡»ğŸ‡º",
        "Vatican City": "ğŸ‡»ğŸ‡¦", "Venezuela": "ğŸ‡»ğŸ‡ª", "Vietnam": "ğŸ‡»ğŸ‡³", "Yemen": "ğŸ‡¾ğŸ‡ª", "Zambia": "ğŸ‡¿ğŸ‡²",
        "Zimbabwe": "ğŸ‡¿ğŸ‡¼", <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OpenFront 1918 - Drapeaux Mondiaux</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --blue: #00d4ff; --red: #ff3131; --gold: #ffd700; --green: #2ecc71;
            --bg: #111; --header-bg: #000; --text: #fff; --panel: #1a1a1a; --border: #333;
            --iron: #bdc3c7; --stone: #7f8c8d; --oil: #2c3e50; --wood: #27ae60; --wheat: #f1c40f;
        }
        
        * {
            cursor: crosshair !important;
        }

        body { margin: 0; padding: 0; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        #info-header {
            width: 100%; height: 120px;
            background: var(--header-bg); color: var(--text);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--blue); box-sizing: border-box; padding: 0 30px; z-index: 1001;
        }

        .flag-frame { 
            width: 110px; height: 80px; 
            border: 2px solid var(--blue); 
            background: #222; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow: hidden;
            font-size: 3.5em;
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        #flag-emoji { 
            line-height: 1;
            display: block;
        }

        #main-view { display: flex; flex-grow: 1; width: 100%; position: relative; overflow: hidden; }
        
        #side-menu { 
            width: 0; background: var(--panel); overflow-y: auto; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            color: var(--text); display: flex; flex-direction: column; z-index: 1000;
        }
        #side-menu.active { width: 320px; border-right: 2px solid var(--blue); }
        
        .menu-content { width: 300px; padding: 20px; box-sizing: border-box; opacity: 0; transition: 0.3s; }
        #side-menu.active .menu-content { opacity: 1; }

        .money-box { background: #000; padding: 10px; border: 1px dashed var(--gold); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* Styles pour les anciennes barres de ressources (Statistiques) */
        .res-item { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; font-size: 0.85em; border-left: 3px solid var(--blue); padding-left: 10px; }
        .res-bar { flex-grow: 1; height: 6px; background: #333; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .res-fill { height: 100%; background: var(--blue); }

        .pop-section { margin-top: 30px; padding: 15px; background: #000; border: 1px solid var(--border); border-radius: 8px; }
        .ratio-container { width: 100%; height: 25px; display: flex; margin: 10px 0; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .ratio-workers { background: var(--blue); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #000; }
        .ratio-soldiers { background: var(--red); height: 100%; transition: 0.5s; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; color: #fff; }
        
        /* Styles pour les jauges interactives */
        .worker-dist-section { margin-top: 20px; border-top: 1px dashed #444; padding-top: 15px; }
        .sub-gauge-row { margin-bottom: 12px; } /* Espacement augmentÃ© pour les curseurs */
        .sub-gauge-label { font-size: 0.75em; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .sub-gauge-track { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .sub-gauge-fill { height: 100%; transition: width 0.2s ease-out; }
        
        /* Style des curseurs de prioritÃ© */
        .prio-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #333;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }
        .prio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
            border: 2px solid #000;
        }

        #toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: var(--blue); border: none; width: 25px; height: 50px; display: none; z-index: 2000; font-weight: bold; cursor: pointer; border-radius: 0 5px 5px 0; }

        #map { flex-grow: 1; background: #0b0b0b !important; }
        #game-over { position: fixed; inset: 0; background: rgba(20, 0, 0, 0.95); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; }
        
        .btn-restart { margin-top: 20px; padding: 12px 24px; background: var(--red); border: none; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="game-over">
    <h1 style="font-size: 3em; margin-bottom: 10px;">MISSION INTERROMPUE</h1>
    <p>Le temps imparti pour le dÃ©ploiement a expirÃ©.</p>
    <button class="btn-restart" onclick="location.reload()">RÃ‰ESSAYER</button>
</div>

<header id="info-header">
    <div id="timer" style="font-size: 2.5em; color: var(--red); font-weight: bold; width: 60px;">15</div>
    <div style="display: flex; align-items: center; flex-grow: 1; margin-left: 30px;">
        <div class="flag-frame"><span id="flag-emoji">ğŸŒ</span></div>
        <div id="country-name" style="font-size: 1.8em; margin-left: 20px; font-weight: bold; letter-spacing: 1px;">INITIALISATION...</div>
    </div>
    <div id="action-zone"></div>
</header>

<div id="main-view">
    <div id="side-menu">
        <div class="menu-content">
            <h3 style="color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px; margin-bottom: 15px;">GESTION DU TERRITOIRE</h3>
            <div id="hq-name" style="color: var(--gold); margin-bottom: 20px; font-weight: bold;">---</div>

            <div class="money-box">
                <span style="font-size: 1.5em;">ğŸ’°</span>
                <div style="text-align: left;">
                    <div style="font-size: 0.7em; color: var(--gold); font-weight: bold;">BUDGET NATIONAL</div>
                    <div id="money-val" style="font-size: 1.3em; font-family: monospace;">1,240,500 $</div>
                </div>
            </div>

            <!-- Statistiques Stocks -->
            <div class="res-item"><span>Stock Fer</span><div class="res-bar"><div class="res-fill" style="width: 70%;"></div></div></div>
            <div class="res-item"><span>Stock BlÃ©</span><div class="res-bar"><div class="res-fill" style="width: 80%;"></div></div></div>

            <div class="pop-section">
                <div style="font-size: 0.8em; color: var(--blue); margin-bottom: 10px; font-weight: bold;">POPULATION TOTALE</div>
                <div class="ratio-container">
                    <div id="workers-bar" class="ratio-workers" style="width: 70%;">TRAVAIL</div>
                    <div id="soldiers-bar" class="ratio-soldiers" style="width: 30%;">ARMÃ‰E</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7em; margin-top: 8px;">
                    <span id="pop-total">Pop: ---</span>
                    <span id="mobilization-text" style="color: var(--red); font-weight: bold;">Mobilisation: 30%</span>
                </div>
                <input type="range" min="0" max="100" value="30" style="width:100%; margin-top:15px;" oninput="updateMainRatio(this.value)">

                <!-- SECTION : Jauges de rÃ©partition des travailleurs INTERACTIVES -->
                <div class="worker-dist-section">
                    <div style="font-size: 0.75em; color: #fff; margin-bottom: 12px; font-weight: bold; border-left: 3px solid var(--gold); padding-left: 8px;">
                        AFFECTATION DES TRAVAILLEURS
                    </div>

                    <!-- Fer -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>â›ï¸ Fer</span><span id="txt-fer" style="color:var(--iron)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-fer" class="sub-gauge-fill" style="background: var(--iron); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- PÃ©trole -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸ›¢ï¸ PÃ©trole</span><span id="txt-oil" style="color: #4a69bd">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-oil" class="sub-gauge-fill" style="background: var(--oil); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="10" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- Pierre -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸ§± Pierre</span><span id="txt-stone" style="color:var(--stone)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-stone" class="sub-gauge-fill" style="background: var(--stone); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- ForÃªt -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸŒ² ForÃªt</span><span id="txt-wood" style="color:var(--wood)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wood" class="sub-gauge-fill" style="background: var(--wood); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="20" oninput="updateWorkerDistribution()">
                    </div>

                    <!-- BlÃ© -->
                    <div class="sub-gauge-row">
                        <div class="sub-gauge-label"><span>ğŸŒ¾ BlÃ©</span><span id="txt-wheat" style="color:var(--wheat)">0%</span></div>
                        <div class="sub-gauge-track"><div id="gauge-wheat" class="sub-gauge-fill" style="background: var(--wheat); width: 0%;"></div></div>
                        <input type="range" class="prio-slider" min="0" max="100" value="30" oninput="updateWorkerDistribution()">
                    </div>
                    
                    <div style="font-size: 0.65em; color: #666; margin-top: 5px; text-align: right;">Total Travailleurs: 100%</div>
                </div>
            </div>
        </div>
    </div>
    <button id="toggle-btn" onclick="toggleMenu()">></button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { 
        attributionControl: false, 
        zoomControl: false, 
        minZoom: 2,
        maxBounds: [[-90, -180], [90, 180]]
    }).setView([20, 0], 2);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { 
        noWrap: true 
    }).addTo(map);

    let hqLocked = false, selectedLayer = null, timeLeft = 15;
    const flagDisplay = document.getElementById('flag-emoji');
    const countryDisplay = document.getElementById('country-name');
    let currentWorkerPct = 70; // Valeur par dÃ©faut
    let currentPopulationMillions = 42.5; // Population dynamique

    // Dictionnaire manuel des drapeaux
    const flagMap = {
        "Afghanistan": "ğŸ‡¦ğŸ‡«", "Albania": "ğŸ‡¦ğŸ‡±", "Algeria": "ğŸ‡©ğŸ‡¿", "Andorra": "ğŸ‡¦ğŸ‡©", "Angola": "ğŸ‡¦ğŸ‡´",
        "Antigua and Barbuda": "ğŸ‡¦ğŸ‡¬", "Argentina": "ğŸ‡¦ğŸ‡·", "Armenia": "ğŸ‡¦ğŸ‡²", "Australia": "ğŸ‡¦ğŸ‡º", "Austria": "ğŸ‡¦ğŸ‡¹",
        "Azerbaijan": "ğŸ‡¦ğŸ‡¿", "Bahamas": "ğŸ‡§ğŸ‡¸", "Bahrain": "ğŸ‡§ğŸ‡­", "Bangladesh": "ğŸ‡§ğŸ‡©", "Barbados": "ğŸ‡§ğŸ‡§",
        "Belarus": "ğŸ‡§ğŸ‡¾", "Belgium": "ğŸ‡§ğŸ‡ª", "Belize": "ğŸ‡§ğŸ‡¿", "Benin": "ğŸ‡§ğŸ‡¯", "Bhutan": "ğŸ‡§ğŸ‡¹",
        "Bolivia": "ğŸ‡§ğŸ‡´", "Bosnia and Herzegovina": "ğŸ‡§ğŸ‡¦", "Botswana": "ğŸ‡§ğŸ‡¼", "Brazil": "ğŸ‡§ğŸ‡·", "Brunei": "ğŸ‡§ğŸ‡³",
        "Bulgaria": "ğŸ‡§ğŸ‡¬", "Burkina Faso": "ğŸ‡§ğŸ‡«", "Burundi": "ğŸ‡§ğŸ‡®", "Cabo Verde": "ğŸ‡¨ğŸ‡»", "Cambodia": "ğŸ‡°ğŸ‡­",
        "Cameroon": "ğŸ‡¨ğŸ‡²", "Canada": "ğŸ‡¨ğŸ‡¦", "Central African Republic": "ğŸ‡¨ğŸ‡«", "Chad": "ğŸ‡¹ğŸ‡©", "Chile": "ğŸ‡¨ğŸ‡±",
        "China": "ğŸ‡¨ğŸ‡³", "Colombia": "ğŸ‡¨ğŸ‡´", "Comoros": "ğŸ‡°ğŸ‡²", "Congo (Democratic Republic of the)": "ğŸ‡¨ğŸ‡©", "Congo (Republic of the)": "ğŸ‡¨ğŸ‡¬",
        "Costa Rica": "ğŸ‡¨ğŸ‡·", "Croatia": "ğŸ‡­ğŸ‡·", "Cuba": "ğŸ‡¨ğŸ‡º", "Cyprus": "ğŸ‡¨ğŸ‡¾", "Czech Republic": "ğŸ‡¨ğŸ‡¿",
        "Denmark": "ğŸ‡©ğŸ‡°", "Djibouti": "ğŸ‡©á´Š", "Dominica": "ğŸ‡©ğŸ‡²", "Dominican Republic": "ğŸ‡©ğŸ‡´", "East Timor": "ğŸ‡¹ğŸ‡±",
        "Ecuador": "ğŸ‡ªğŸ‡¨", "Egypt": "ğŸ‡ªğŸ‡¬", "El Salvador": "ğŸ‡¸ğŸ‡»", "Equatorial Guinea": "ğŸ‡¬ğŸ‡¶", "Eritrea": "ğŸ‡ªğŸ‡·",
        "Estonia": "ğŸ‡ªğŸ‡ª", "Eswatini": "ğŸ‡¸ğŸ‡¿", "Ethiopia": "ğŸ‡ªğŸ‡¹", "Fiji": "ğŸ‡«ğŸ‡¯", "Finland": "ğŸ‡«ğŸ‡®",
        "France": "ğŸ‡«ğŸ‡·", "Gabon": "ğŸ‡¬ğŸ‡¦", "Gambia": "ğŸ‡¬ğŸ‡²", "Georgia": "ğŸ‡¬ğŸ‡ª", "Germany": "ğŸ‡©ğŸ‡ª",
        "Ghana": "ğŸ‡¬ğŸ‡­", "Greece": "ğŸ‡¬ğŸ‡·", "Grenada": "ğŸ‡¬ğŸ‡©", "Guatemala": "ğŸ‡¬ğŸ‡¹", "Guinea": "ğŸ‡¬ğŸ‡³",
        "Guinea-Bissau": "ğŸ‡¬ğŸ‡¼", "Guyana": "ğŸ‡¬ğŸ‡¾", "Haiti": "ğŸ‡­ğŸ‡¹", "Honduras": "ğŸ‡­ğŸ‡³", "Hungary": "ğŸ‡­ğŸ‡º",
        "Iceland": "ğŸ‡®ğŸ‡¸", "India": "ğŸ‡®ğŸ‡³", "Indonesia": "ğŸ‡®ğŸ‡©", "Iran": "ğŸ‡®ğŸ‡·", "Iraq": "ğŸ‡®ğŸ‡¶",
        "Ireland": "ğŸ‡®ğŸ‡ª", "Israel": "ğŸ‡®ğŸ‡±", "Italy": "ğŸ‡®ğŸ‡¹", "Ivory Coast": "ğŸ‡¨ğŸ‡®", "Jamaica": "ğŸ‡¯ğŸ‡²",
        "Japan": "ğŸ‡¯ğŸ‡µ", "Jordan": "ğŸ‡¯ğŸ‡´", "Kazakhstan": "ğŸ‡°ğŸ‡¿", "Kenya": "ğŸ‡°ğŸ‡ª", "Kiribati": "ğŸ‡°ğŸ‡®",
        "Kuwait": "ğŸ‡°ğŸ‡¼", "Kyrgyzstan": "ğŸ‡°ğŸ‡¬", "Laos": "ğŸ‡±ğŸ‡¦", "Latvia": "ğŸ‡±ğŸ‡»", "Lebanon": "ğŸ‡±ğŸ‡§",
        "Lesotho": "ğŸ‡±ğŸ‡¸", "Liberia": "ğŸ‡±ğŸ‡·", "Libya": "ğŸ‡±ğŸ‡¾", "Liechtenstein": "ğŸ‡±ğŸ‡®", "Lithuania": "ğŸ‡±ğŸ‡¹",
        "Luxembourg": "ğŸ‡±ğŸ‡º", "Madagascar": "ğŸ‡²ğŸ‡¬", "Malawi": "ğŸ‡²ğŸ‡¼", "Malaysia": "ğŸ‡²ğŸ‡¾", "Maldives": "ğŸ‡²ğŸ‡»",
        "Mali": "ğŸ‡²ğŸ‡±", "Malta": "ğŸ‡²ğŸ‡¹", "Marshall Islands": "ğŸ‡²ğŸ‡­", "Mauritania": "ğŸ‡²ğŸ‡·", "Mauritius": "ğŸ‡²ğŸ‡º",
        "Mexico": "ğŸ‡²ğŸ‡½", "Micronesia": "ğŸ‡«ğŸ‡²", "Moldova": "ğŸ‡²ğŸ‡©", "Monaco": "ğŸ‡²ğŸ‡¨", "Mongolia": "ğŸ‡²ğŸ‡³",
        "Montenegro": "ğŸ‡²ğŸ‡ª", "Morocco": "ğŸ‡²ğŸ‡¦", "Mozambique": "ğŸ‡²ğŸ‡¿", "Myanmar": "ğŸ‡²ğŸ‡²", "Namibia": "ğŸ‡³ğŸ‡¦",
        "Nauru": "ğŸ‡³ğŸ‡·", "Nepal": "ğŸ‡³ğŸ‡µ", "Netherlands": "ğŸ‡³ğŸ‡±", "New Zealand": "ğŸ‡³ğŸ‡¿", "Nicaragua": "ğŸ‡³ğŸ‡®",
        "Niger": "ğŸ‡³ğŸ‡ª", "Nigeria": "ğŸ‡³ğŸ‡¬", "North Korea": "ğŸ‡°ğŸ‡µ", "North Macedonia": "ğŸ‡²ğŸ‡°", "Norway": "ğŸ‡³ğŸ‡´",
        "Oman": "ğŸ‡´ğŸ‡²", "Pakistan": "ğŸ‡µğŸ‡°", "Palau": "ğŸ‡µğŸ‡¼", "Palestine": "ğŸ‡µğŸ‡¸", "Panama": "ğŸ‡µğŸ‡¦",
        "Papua New Guinea": "ğŸ‡µğŸ‡¬", "Paraguay": "ğŸ‡µğŸ‡¾", "Peru": "ğŸ‡µğŸ‡ª", "Philippines": "ğŸ‡µğŸ‡­", "Poland": "ğŸ‡µğŸ‡±",
        "Portugal": "ğŸ‡µğŸ‡¹", "Qatar": "ğŸ‡¶ğŸ‡¦", "Romania": "ğŸ‡·ğŸ‡´", "Russia": "ğŸ‡·ğŸ‡º", "Rwanda": "ğŸ‡·ğŸ‡¼",
        "Saint Kitts and Nevis": "ğŸ‡°ğŸ‡³", "Saint Lucia": "ğŸ‡±ğŸ‡¨", "Saint Vincent and the Grenadines": "ğŸ‡»ğŸ‡¨", "Samoa": "ğŸ‡¼ğŸ‡¸", "San Marino": "ğŸ‡¸ğŸ‡²",
        "Sao Tome and Principe": "ğŸ‡¸ğŸ‡¹", "Saudi Arabia": "ğŸ‡¸ğŸ‡¦", "Senegal": "ğŸ‡¸ğŸ‡³", "Serbia": "ğŸ‡·ğŸ‡¸", "Seychelles": "ğŸ‡¸ğŸ‡¨",
        "Sierra Leone": "ğŸ‡¸ğŸ‡±", "Singapore": "ğŸ‡¸ğŸ‡¬", "Slovakia": "ğŸ‡¸ğŸ‡°", "Slovenia": "ğŸ‡¸ğŸ‡®", "Solomon Islands": "ğŸ‡¸ğŸ‡§",
        "Somalia": "ğŸ‡¸ğŸ‡´", "South Africa": "ğŸ‡¿ğŸ‡¦", "South Korea": "ğŸ‡°ğŸ‡·", "South Sudan": "ğŸ‡¸ğŸ‡¸", "Spain": "ğŸ‡ªğŸ‡¸",
        "Sri Lanka": "ğŸ‡±ğŸ‡°", "Sudan": "ğŸ‡¸ğŸ‡©", "Suriname": "ğŸ‡¸ğŸ‡·", "Sweden": "ğŸ‡¸ğŸ‡ª", "Switzerland": "ğŸ‡¨ğŸ‡­",
        "Syria": "ğŸ‡¸ğŸ‡¾", "Taiwan": "ğŸ‡¹ğŸ‡¼", "Tajikistan": "ğŸ‡¹ğŸ‡¯", "Tanzania": "ğŸ‡¹ğŸ‡¿", "Thailand": "ğŸ‡¹ğŸ‡­",
        "Togo": "ğŸ‡¹ğŸ‡¬", "Tonga": "ğŸ‡¹ğŸ‡´", "Trinidad and Tobago": "ğŸ‡¹ğŸ‡¹", "Tunisia": "ğŸ‡¹ğŸ‡³", "Turkey": "ğŸ‡¹ğŸ‡·",
        "Turkmenistan": "ğŸ‡¹ğŸ‡²", "Tuvalu": "ğŸ‡¹ğŸ‡»", "Uganda": "ğŸ‡ºğŸ‡¬", "Ukraine": "ğŸ‡ºğŸ‡¦", "United Arab Emirates": "ğŸ‡¦ğŸ‡ª",
        "United Kingdom": "ğŸ‡¬ğŸ‡§", "United States of America": "ğŸ‡ºğŸ‡¸", "Uruguay": "ğŸ‡ºğŸ‡¾", "Uzbekistan": "ğŸ‡ºğŸ‡¿", "Vanuatu": "ğŸ‡»ğŸ‡º",
        "Vatican City": "ğŸ‡»ğŸ‡¦", "Venezuela": "ğŸ‡»ğŸ‡ª", "Vietnam": "ğŸ‡»ğŸ‡³", "Yemen": "ğŸ‡¾ğŸ‡ª", "Zambia": "ğŸ‡¿ğŸ‡²",
        "Zimbabwe": "ğŸ‡¿ğŸ‡¼", "Baykonur cosmodrome": "ğŸ‡°ğŸ‡¿", "Somaliland": "ğŸ‡¸ğŸ‡´", "Democratic republic of the congo": "ğŸ‡¨ğŸ‡©"
    };

    // Mise Ã  jour de la barre principale (ArmÃ©e vs Travailleurs)
    window.updateMainRatio = function(val) {
        const soldierPct = parseInt(val);
        currentWorkerPct = 100 - soldierPct;

        document.getElementById('soldiers-bar').style.width = soldierPct + "%";
        document.getElementById('workers-bar').style.width = currentWorkerPct + "%";
        document.getElementById('mobilization-text').innerText = "Mobilisation: " + soldierPct + "%";

        // Recalculer la distribution des travailleurs car la population de travailleurs a changÃ©
        window.updateWorkerDistribution();
    };

    // Nouvelle fonction pour gÃ©rer la rÃ©partition dynamique
    window.updateWorkerDistribution = function() {
        const sliders = document.querySelectorAll('.prio-slider');
        const weights = Array.from(sliders).map(s => parseInt(s.value));
        const totalWeight = weights.reduce((a, b) => a + b, 0) || 1; 

        // Calcul de la main d'Å“uvre DISPONIBLE
        const totalWorkersAvailable = currentPopulationMillions * (currentWorkerPct / 100);

        const resourceIds = ['fer', 'oil', 'stone', 'wood', 'wheat'];

        weights.forEach((weight, index) => {
            const id = resourceIds[index];
            const relativePct = (weight / totalWeight); 
            const displayPct = Math.round(relativePct * 100);
            
            const workersForResource = totalWorkersAvailable * relativePct;
            const workersFormatted = workersForResource.toFixed(1) + "M";

            const visualWidth = relativePct * 100;
            document.getElementById(`gauge-${id}`).style.width = visualWidth + "%";
            document.getElementById(`txt-${id}`).innerText = `${displayPct}% (${workersFormatted})`;
        });
    };

    // Initialisation
    window.updateMainRatio(30);

    const countdown = setInterval(() => {
        if (hqLocked) return;
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) { 
            clearInterval(countdown); 
            document.getElementById('game-over').style.display = 'flex'; 
        }
    }, 1000);

    function getFlagEmoji(isoCode, countryName) {
        if (flagMap[countryName]) return flagMap[countryName];
        if (isoCode && isoCode !== "-99" && isoCode.length === 2) {
            const code = isoCode.toUpperCase();
            return String.fromCodePoint(...[...code].map(c => c.charCodeAt(0) + 127397));
        }
        return "ğŸŒ"; 
    }

    // Fonction de calcul de population CORRIGÃ‰E V2
    function calculatePopulation(layer) {
        const bounds = layer.getBounds();
        // Calcul simple largeur/hauteur en degrÃ©s
        let width = Math.abs(bounds.getEast() - bounds.getWest());
        const height = Math.abs(bounds.getNorth() - bounds.getSouth());
        const center = bounds.getCenter();

        // 1. Correction Russie et pays "qui dÃ©passent" (Largeur monde)
        // La Russie traverse souvent la date (-180/180), donc sa largeur brute peut paraÃ®tre petite ou Ã©norme selon le GeoJSON
        // Ici on assume une largeur brute. Si c'est > 180, c'est probablement un empire/monde.
        // On ne la cape plus artificiellement Ã  60, on laisse la "vraie" taille s'exprimer (360 max).
        // Cela va rendre la Russie "trÃ¨s grande" -> donc "trÃ¨s peu peuplÃ©e" selon la rÃ¨gle inversÃ©e.
        
        // 2. Score de surface approximatif (DegrÃ©s carrÃ©s)
        let areaScore = width * height;

        // 3. Correction Latitude (PÃ©nalitÃ© Grand Nord)
        // Les pays au nord (Groenland, Russie, Canada) sont visuellement Ã©tirÃ©s par Mercator.
        // On augmente leur score pour rÃ©duire encore leur population.
        // Groenland (~75N) vs Russie (~60N). Groenland prendra un plus gros malus visuel.
        if (Math.abs(center.lat) > 50) {
            // Facteur augmentant avec la latitude
            const latFactor = 1 + (Math.abs(center.lat) - 50) / 20; 
            areaScore = areaScore * latFactor; 
        }

        // 4. Formule Exponentielle ajustÃ©e (Moins raide)
        // Petit pays (Area ~1-10) -> Tend vers maxPop
        // Moyen pays (Area ~100) -> Milieu
        // GÃ©ant (Area ~2000+) -> Tend vers minPop
        
        const minPop = 2;   // Minimum 2M (Russie, Canada, Australie...)
        const maxPop = 60;  // Maximum 60M (Petits pays denses : Belgique, Suisse...)
        
        // Coefficient de dÃ©croissance k
        // Si Area = 6000 (Russie), on veut Ãªtre proche de minPop.
        // Si Area = 500 (France), on veut Ãªtre moyen (ex: 30-40M).
        // Si Area = 5 (Belgique), on veut Ãªtre proche de maxPop (60M).
        
        // Formule : Pop = Min + (Max - Min) * e^(-k * Area)
        // On choisit k = 0.0004 pour adoucir la pente.
        let pop = minPop + (maxPop - minPop) * Math.exp(-0.0004 * areaScore);
        
        return pop.toFixed(1);
    }

    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(r => r.json())
    .then(data => {
        L.geoJson(data, {
            style: { fillColor: '#222', fillOpacity: 0.7, color: '#444', weight: 1 },
            onEachFeature: (feature, layer) => {
                
                layer.on('mouseover', function() {
                    if(hqLocked) return;
                    this.setStyle({ fillOpacity: 0.9, fillColor: '#444', color: '#00d4ff' });
                    
                    const props = feature.properties;
                    const name = props.ADMIN || props.name || "Inconnu";
                    const iso = props.ISO_A2 || props.iso_a2 || "";
                    
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji(iso.trim(), name);
                });

                layer.on('mouseout', function() {
                    if (this !== selectedLayer) {
                        this.setStyle({ fillOpacity: 0.7, fillColor: '#222', color: '#444' });
                    }
                    if(hqLocked) return;

                    if (selectedLayer) {
                        const p = selectedLayer.feature.properties;
                        const name = p.ADMIN || p.name;
                        countryDisplay.innerText = name.toUpperCase();
                        flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);
                    } else {
                        countryDisplay.innerText = "SÃ‰LECTIONNEZ UNE ZONE";
                        flagDisplay.innerText = "ğŸŒ";
                    }
                });

                layer.on('click', function() {
                    if(hqLocked) return;
                    if(selectedLayer) selectedLayer.setStyle({ fillColor: '#222', weight: 1, color: '#444' });
                    selectedLayer = this;
                    this.setStyle({ fillColor: '#333', weight: 2, color: '#00d4ff' });
                    
                    const p = feature.properties;
                    const name = p.ADMIN || p.name;
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);

                    // --- Calcul de la population ---
                    const pop = calculatePopulation(layer);
                    currentPopulationMillions = parseFloat(pop);
                    
                    // Mise Ã  jour de l'affichage
                    document.getElementById('pop-total').innerText = "Pop: " + pop + "M";
                    window.updateWorkerDistribution(); 

                    document.getElementById('action-zone').innerHTML = `
                        <button onclick="lockHQ()" style="background:var(--blue); border:none; padding:10px 20px; font-weight:bold; color:black; cursor:pointer; border-radius:4px;">
                            Ã‰TABLIR QG
                        </button>`;
                });
            }
        }).addTo(map);
    });

    window.lockHQ = function() {
        if (!selectedLayer) return;
        hqLocked = true;
        selectedLayer.setStyle({ fillColor: '#00d4ff', color: '#ffd700', weight: 3, fillOpacity: 0.8 });
        document.getElementById('side-menu').classList.add('active');
        document.getElementById('toggle-btn').style.display = 'block';
        document.getElementById('toggle-btn').style.left = "320px";
        document.getElementById('hq-name').innerText = "QG ACTIVÃ‰ : " + countryDisplay.innerText;
        document.getElementById('action-zone').innerHTML = `<span style="color:var(--green); font-weight:bold;">PROFIL ACTIVÃ‰</span>`;
        map.fitBounds(selectedLayer.getBounds(), { padding: [50, 50] });
    };

    window.toggleMenu = function() {
        const menu = document.getElementById('side-menu');
        const btn = document.getElementById('toggle-btn');
        const isOpen = menu.classList.toggle('active');
        btn.innerText = isOpen ? "<" : ">";
        btn.style.left = isOpen ? "320px" : "0";
    };
</script>
</body>
</html>
    };

    // Mise Ã  jour de la barre principale (ArmÃ©e vs Travailleurs)
    window.updateMainRatio = function(val) {
        const soldierPct = parseInt(val);
        currentWorkerPct = 100 - soldierPct;

        document.getElementById('soldiers-bar').style.width = soldierPct + "%";
        document.getElementById('workers-bar').style.width = currentWorkerPct + "%";
        document.getElementById('mobilization-text').innerText = "Mobilisation: " + soldierPct + "%";

        // Recalculer la distribution des travailleurs car la population de travailleurs a changÃ©
        window.updateWorkerDistribution();
    };

    // Nouvelle fonction pour gÃ©rer la rÃ©partition dynamique
    window.updateWorkerDistribution = function() {
        const sliders = document.querySelectorAll('.prio-slider');
        const weights = Array.from(sliders).map(s => parseInt(s.value));
        const totalWeight = weights.reduce((a, b) => a + b, 0) || 1; 

        // Calcul de la main d'Å“uvre DISPONIBLE
        const totalWorkersAvailable = currentPopulationMillions * (currentWorkerPct / 100);

        const resourceIds = ['fer', 'oil', 'stone', 'wood', 'wheat'];

        weights.forEach((weight, index) => {
            const id = resourceIds[index];
            const relativePct = (weight / totalWeight); 
            const displayPct = Math.round(relativePct * 100);
            
            const workersForResource = totalWorkersAvailable * relativePct;
            const workersFormatted = workersForResource.toFixed(1) + "M";

            const visualWidth = relativePct * 100;
            document.getElementById(`gauge-${id}`).style.width = visualWidth + "%";
            document.getElementById(`txt-${id}`).innerText = `${displayPct}% (${workersFormatted})`;
        });
    };

    // Initialisation
    window.updateMainRatio(30);

    const countdown = setInterval(() => {
        if (hqLocked) return;
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) { 
            clearInterval(countdown); 
            document.getElementById('game-over').style.display = 'flex'; 
        }
    }, 1000);

    function getFlagEmoji(isoCode, countryName) {
        if (flagMap[countryName]) return flagMap[countryName];
        if (isoCode && isoCode !== "-99" && isoCode.length === 2) {
            const code = isoCode.toUpperCase();
            return String.fromCodePoint(...[...code].map(c => c.charCodeAt(0) + 127397));
        }
        return "ğŸŒ"; 
    }

    // Fonction de calcul de population CORRIGÃ‰E V2
    function calculatePopulation(layer) {
        const bounds = layer.getBounds();
        // Calcul simple largeur/hauteur en degrÃ©s
        let width = Math.abs(bounds.getEast() - bounds.getWest());
        const height = Math.abs(bounds.getNorth() - bounds.getSouth());
        const center = bounds.getCenter();

        // 1. Correction Russie et pays "qui dÃ©passent" (Largeur monde)
        // La Russie traverse souvent la date (-180/180), donc sa largeur brute peut paraÃ®tre petite ou Ã©norme selon le GeoJSON
        // Ici on assume une largeur brute. Si c'est > 180, c'est probablement un empire/monde.
        // On ne la cape plus artificiellement Ã  60, on laisse la "vraie" taille s'exprimer (360 max).
        // Cela va rendre la Russie "trÃ¨s grande" -> donc "trÃ¨s peu peuplÃ©e" selon la rÃ¨gle inversÃ©e.
        
        // 2. Score de surface approximatif (DegrÃ©s carrÃ©s)
        let areaScore = width * height;

        // 3. Correction Latitude (PÃ©nalitÃ© Grand Nord)
        // Les pays au nord (Groenland, Russie, Canada) sont visuellement Ã©tirÃ©s par Mercator.
        // On augmente leur score pour rÃ©duire encore leur population.
        // Groenland (~75N) vs Russie (~60N). Groenland prendra un plus gros malus visuel.
        if (Math.abs(center.lat) > 50) {
            // Facteur augmentant avec la latitude
            const latFactor = 1 + (Math.abs(center.lat) - 50) / 20; 
            areaScore = areaScore * latFactor; 
        }

        // 4. Formule Exponentielle ajustÃ©e (Moins raide)
        // Petit pays (Area ~1-10) -> Tend vers maxPop
        // Moyen pays (Area ~100) -> Milieu
        // GÃ©ant (Area ~2000+) -> Tend vers minPop
        
        const minPop = 2;   // Minimum 2M (Russie, Canada, Australie...)
        const maxPop = 60;  // Maximum 60M (Petits pays denses : Belgique, Suisse...)
        
        // Coefficient de dÃ©croissance k
        // Si Area = 6000 (Russie), on veut Ãªtre proche de minPop.
        // Si Area = 500 (France), on veut Ãªtre moyen (ex: 30-40M).
        // Si Area = 5 (Belgique), on veut Ãªtre proche de maxPop (60M).
        
        // Formule : Pop = Min + (Max - Min) * e^(-k * Area)
        // On choisit k = 0.0004 pour adoucir la pente.
        let pop = minPop + (maxPop - minPop) * Math.exp(-0.0004 * areaScore);
        
        return pop.toFixed(1);
    }

    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(r => r.json())
    .then(data => {
        L.geoJson(data, {
            style: { fillColor: '#222', fillOpacity: 0.7, color: '#444', weight: 1 },
            onEachFeature: (feature, layer) => {
                
                layer.on('mouseover', function() {
                    if(hqLocked) return;
                    this.setStyle({ fillOpacity: 0.9, fillColor: '#444', color: '#00d4ff' });
                    
                    const props = feature.properties;
                    const name = props.ADMIN || props.name || "Inconnu";
                    const iso = props.ISO_A2 || props.iso_a2 || "";
                    
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji(iso.trim(), name);
                });

                layer.on('mouseout', function() {
                    if (this !== selectedLayer) {
                        this.setStyle({ fillOpacity: 0.7, fillColor: '#222', color: '#444' });
                    }
                    if(hqLocked) return;

                    if (selectedLayer) {
                        const p = selectedLayer.feature.properties;
                        const name = p.ADMIN || p.name;
                        countryDisplay.innerText = name.toUpperCase();
                        flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);
                    } else {
                        countryDisplay.innerText = "SÃ‰LECTIONNEZ UNE ZONE";
                        flagDisplay.innerText = "ğŸŒ";
                    }
                });

                layer.on('click', function() {
                    if(hqLocked) return;
                    if(selectedLayer) selectedLayer.setStyle({ fillColor: '#222', weight: 1, color: '#444' });
                    selectedLayer = this;
                    this.setStyle({ fillColor: '#333', weight: 2, color: '#00d4ff' });
                    
                    const p = feature.properties;
                    const name = p.ADMIN || p.name;
                    countryDisplay.innerText = name.toUpperCase();
                    flagDisplay.innerText = getFlagEmoji((p.ISO_A2 || p.iso_a2 || "").trim(), name);

                    // --- Calcul de la population ---
                    const pop = calculatePopulation(layer);
                    currentPopulationMillions = parseFloat(pop);
                    
                    // Mise Ã  jour de l'affichage
                    document.getElementById('pop-total').innerText = "Pop: " + pop + "M";
                    window.updateWorkerDistribution(); 

                    document.getElementById('action-zone').innerHTML = `
                        <button onclick="lockHQ()" style="background:var(--blue); border:none; padding:10px 20px; font-weight:bold; color:black; cursor:pointer; border-radius:4px;">
                            Ã‰TABLIR QG
                        </button>`;
                });
            }
        }).addTo(map);
    });

    window.lockHQ = function() {
        if (!selectedLayer) return;
        hqLocked = true;
        selectedLayer.setStyle({ fillColor: '#00d4ff', color: '#ffd700', weight: 3, fillOpacity: 0.8 });
        document.getElementById('side-menu').classList.add('active');
        document.getElementById('toggle-btn').style.display = 'block';
        document.getElementById('toggle-btn').style.left = "320px";
        document.getElementById('hq-name').innerText = "QG ACTIVÃ‰ : " + countryDisplay.innerText;
        document.getElementById('action-zone').innerHTML = `<span style="color:var(--green); font-weight:bold;">PROFIL ACTIVÃ‰</span>`;
        map.fitBounds(selectedLayer.getBounds(), { padding: [50, 50] });
    };

    window.toggleMenu = function() {
        const menu = document.getElementById('side-menu');
        const btn = document.getElementById('toggle-btn');
        const isOpen = menu.classList.toggle('active');
        btn.innerText = isOpen ? "<" : ">";
        btn.style.left = isOpen ? "320px" : "0";
    };
</script>
</body>
</html>
